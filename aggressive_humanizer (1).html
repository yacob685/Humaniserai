
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Human Content Generator Pro</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: #f3f4f6;
    min-height: 100vh;
    color: #2c3e50;
}

header {
    background-color: white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

nav {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

nav a.nav-brand {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4f46e5;
    text-decoration: none;
}

.nav-links {
    display: flex;
    gap: 1.5rem;
    align-items: center;
}

.nav-links a {
    color: #6b7280;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
}

.nav-links a:hover {
    color: #4f46e5;
}

.container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    max-width: 1400px;
    width: 90%;
    margin: 2rem auto;
    padding: 40px;
    border: 1px solid #e0e0e0;
}

h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 2.2em;
    font-weight: 700;
}

.subtitle {
    text-align: center;
    color: #6c757d;
    margin-bottom: 12px;
    font-size: 1.1em;
    font-weight: 400;
}

.power-badge {
    text-align: center;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 12px 28px;
    border-radius: 25px;
    display: block;
    width: fit-content;
    margin: 0 auto 30px auto;
    font-weight: 600;
    font-size: 0.95em;
    box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
}

.api-section {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.api-section label {
    color: #495057 !important;
}

.input-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    color: #495057;
    font-weight: 600;
    font-size: 0.95em;
}

input[type="text"],
textarea,
select,
input[type="number"] {
    width: 100%;
    padding: 14px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
    font-family: inherit;
    background: white;
}

select {
    cursor: pointer;
}

input[type="text"]:focus,
textarea:focus,
select:focus,
input[type="number"]:focus {
    outline: none;
    border-color: #e74c3c;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
}

textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
}

.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 18px;
    margin-bottom: 25px;
}

.button-container {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

button {
    flex: 1;
    padding: 16px 32px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.generate-btn {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
}

.generate-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(231, 76, 60, 0.4);
}

.generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.clear-btn {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    color: white;
}

.clear-btn:hover {
    background: linear-gradient(135deg, #5a6268, #495057);
    transform: translateY(-2px);
}

.output-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    min-height: 400px;
    position: relative;
    border: 2px solid #dee2e6;
}

.output-content {
    white-space: pre-wrap;
    line-height: 1.8;
    color: #2c3e50;
    font-size: 15px;
}

.loading {
    display: none;
    text-align: center;
    padding: 60px 20px;
}

.loading.active {
    display: block;
}

.spinner {
    border: 5px solid #e9ecef;
    border-top: 5px solid #e74c3c;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: #e74c3c;
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 8px;
}

.loading-subtext {
    color: #6c757d;
    font-size: 0.95em;
    font-weight: 400;
}

.copy-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
}

.copy-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 12px rgba(40, 167, 69, 0.4);
}

.error {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    border: 1px solid #bd2130;
    font-weight: 500;
}

.error.active {
    display: block;
}

.success {
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    border: 1px solid #1e7e34;
    font-weight: 500;
}

.success.active {
    display: block;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 15px;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid #dee2e6;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #dee2e6;
    transition: all 0.3s;
}

.stat-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: #e74c3c;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #e74c3c;
}

.stat-label {
    color: #6c757d;
    font-size: 0.85em;
    margin-top: 8px;
    font-weight: 500;
}

.human-score {
    text-align: center;
    margin-top: 20px;
    padding: 18px;
    background: linear-gradient(135deg, #28a745, #218838);
    color: white;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.05em;
    display: none;
    box-shadow: 0 2px 12px rgba(40, 167, 69, 0.3);
    border: 1px solid #1e7e34;
}

.human-score.active {
    display: block;
}

.intensity-slider {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.slider-container {
    margin-top: 12px;
}

input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, #e74c3c, #c0392b);
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #e74c3c;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
}

input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #e74c3c;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
    border: none;
}

.intensity-label {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    font-weight: 500;
    color: #495057;
    font-size: 0.9em;
}

.feature-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 25px;
    justify-content: center;
}

.badge {
    background: #e9ecef;
    color: #495057;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8em;
    border: 1px solid #dee2e6;
}

@media (max-width: 768px) {
    .nav-links {
        display: none;
    }
    
    .container {
        width: 95%;
        padding: 20px;
    }
    
    h1 {
        font-size: 1.8em;
    }
}

        .history-item {
    background: white;
    padding: 15px;
    margin-bottom: 12px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: all 0.3s;
}

.history-item:hover {
    border-color: #e74c3c;
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.2);
    transform: translateX(5px);
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.history-title {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95em;
}

.history-date {
    font-size: 0.8em;
    color: #6c757d;
}

.history-preview {
    color: #495057;
    font-size: 0.85em;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.history-meta {
    display: flex;
    gap: 15px;
    margin-top: 8px;
    font-size: 0.75em;
    color: #6c757d;
}

.history-badge {
    background: #e9ecef;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 600;
}

.delete-history-btn {
    padding: 4px 10px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75em;
    font-weight: 600;
    margin-left: 10px;
}

.delete-history-btn:hover {
    background: #c82333;
}
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="nav-brand">Web Service Hub</a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#tools">All Tools</a>
            </div>
        </nav>
    </header>
    
    <div class="container">
        <h1>🚀 ULTRA-HUMAN CONTENT GENERATOR PRO</h1>
        <p class="subtitle">Generate Authentically Human Content from Scratch - Zero AI Detection</p>
        <div class="power-badge">🔥 DIRECT HUMAN GENERATION | 100% UNDETECTABLE</div>

        <div class="mode-toggle" style="text-align: center; margin-bottom: 25px;">
    <label style="font-weight: 600; color: #495057; margin-bottom: 10px; display: block;">🎯 OPERATION MODE:</label>
    <div style="display: inline-flex; background: #e9ecef; border-radius: 10px; padding: 4px;">
        <button type="button" id="generateMode" class="mode-btn active" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">
            🚀 Generate New Content
        </button>
        <button type="button" id="humanizeMode" class="mode-btn" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: transparent; color: #495057;">
            ✨ Humanize Existing Text
        </button>
                <button type="button" id="enhanceMode" class="mode-btn" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: transparent; color: #495057;">
    🎯 Enhance & Complete Content
</button>
    </div>
</div>

        <!-- DETECTION MODE TOGGLE - Add this after the mode-toggle div -->
<div class="detection-mode-toggle" style="text-align: center; margin-bottom: 25px; margin-top: 15px;">
    <label style="font-weight: 600; color: #495057; margin-bottom: 10px; display: block;">🤖 DETECTION MODE:</label>
    <div style="display: inline-flex; background: #e9ecef; border-radius: 10px; padding: 4px;">
        <button type="button" id="autoDetectBtn" class="detection-btn" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #28a745, #218838); color: white;">
            ✨ Auto-Detect
        </button>
        <button type="button" id="manualSelectBtn" class="detection-btn" style="padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: transparent; color: #495057;">
            🎯 Manual Select
        </button>

    </div>
    <p style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
        <span id="detectionModeDesc">AI automatically detects subject, question type, and format</span>
    </p>
</div>
        <div class="feature-badges">
            <span class="badge">🎯 NATIVE HUMAN GENERATION</span>
            <span class="badge">⚡ ZERO AI PATTERNS</span>
            <span class="badge">📰 ALL CONTENT TYPES</span>
            <span class="badge">🎓 ACADEMIC GRADE</span>
            <span class="badge">💼 PROFESSIONAL READY</span>
            <span class="badge">🚀 MAXIMUM AUTHENTICITY</span>
        </div>

        <div class="api-section" style="display: block;">
            <div class="input-group">
<label for="apiKey">
    🔑 Enter Your Gemini API Key: 
    <a href="https://aistudio.google.com/apikey" 
       target="_blank" 
       style="display: inline-block; margin-left: 10px; padding: 6px 12px; background: linear-gradient(135deg, #4f46e5, #4338ca); color: white; text-decoration: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; transition: transform 0.2s;"
       onmouseover="this.style.transform='translateY(-2px)'"
       onmouseout="this.style.transform='translateY(0)'">
        🔗 Get API Key For Free
    </a>
</label>                <div style="display: block;">
                    <input type="text" id="apiKey" value="">
                </div>
            </div>
        </div>

        <div class="intensity-slider">
            <label>🔥 HUMAN AUTHENTICITY LEVEL:</label>
            <div class="slider-container">
                <input type="range" id="intensity" min="1" max="3" value="3" step="1">
                <div class="intensity-label">
                    <span>Natural</span>
                    <span id="intensityValue">ULTRA-HUMAN</span>
                    <span>Maximum</span>
                </div>
            </div>
        </div>

        <div class="controls-grid">
            <div class="input-group">
                <label for="category">🎯 Content Category:</label>
                <select id="category">
                    <option value="journalism">📰 Journalism & News</option>
                    <option value="academic">🎓 Academic & Research</option>
                    <option value="business">💼 Business & Professional</option>
                    <option value="creative">✨ Creative & Marketing</option>
                    <option value="technical">⚙️ Technical & Documentation</option>
                </select>
                <div class="input-group">
    <label for="textTypeOverride">
        <br><br>
        ✍️ Specify Text Type (Optional - only in Auto-Detect mode)
    </label>
    <input 
        type="text" 
        id="textTypeOverride" 
        placeholder="e.g., academic essay, news article, blog post, research paper, creative story..."
        style="font-size: 15px;"
    >
    <small style="display: block; margin-top: 8px; color: #6c757d; font-size: 0.85em;">
        💡 Leave blank to let AI auto-detect. Type any text type you want (e.g., "acadmic esay" - AI understands even with typos!). Only works in Auto-Detect mode.
    </small>
</div>
</div>

            <div class="input-group">
                <label for="mode">📚 Specific Type:</label>
                <select id="mode">
                    <!-- Options will be populated based on category -->
                </select>
            </div>

            <div class="input-group">
                <label for="wordCount">📊 Target Word Count:</label>
                <input type="number" id="wordCount" min="100" max="5000" value="800" step="50">
            </div>
        </div>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
        <div class="info-restored" id="infoRestored" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #1d4ed8; font-weight: 500;">
    📋 <strong>History Restored:</strong> <span id="restoredInfo"></span>
</div>

      <!-- Generate Mode Inputs -->
<div id="generateInputs">
    <div class="input-group">
        <label for="topic">📝 Content Topic/Brief:</label>
        <textarea id="topic" placeholder="Describe what you want the content to be about. Be specific about key points, angle, or requirements..."></textarea>
    </div>

    <div class="input-group">
        <label for="keywords">🔑 Key Points/Keywords (Optional):</label>
        <input type="text" id="keywords" placeholder="Enter key points or keywords separated by commas (e.g., innovation, technology, sustainability)">
    </div>
</div>

<!-- Humanize Mode Inputs -->
<div id="humanizeInputs" style="display: none;">
    <div class="input-group">
        <label for="existingText">📄 Paste Your Text to Humanize:</label>
        <textarea id="existingText" placeholder="Paste your text here. All citations, researcher names, dates, and specific data will be preserved exactly as written..." style="min-height: 300px;"></textarea>
    </div>
    
    <div class="input-group" style="padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
        <label style="color: #856404; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2em;">⚠️</span>
            <span>PRESERVATION GUARANTEE:</span>
        </label>
        <ul style="margin: 10px 0 0 25px; color: #856404; line-height: 1.8;">
            <li>All researcher names preserved exactly (e.g., "Smith (2023)", "Johnson et al.")</li>
            <li>All dates and years maintained precisely</li>
            <li>All citations and references kept intact</li>
            <li>All statistics, percentages, and numbers unchanged</li>
            <li>All specific research findings preserved verbatim</li>
            <li>Technical terms and discipline-specific vocabulary protected</li>
        </ul>
    </div>
</div>


        <div id="enhanceInputs" style="display: none;">
    <div class="input-group">
        <label for="contentToEnhance">📄 Paste Content to Enhance:</label>
        <textarea id="contentToEnhance" placeholder="Paste your existing content here..." style="min-height: 300px;"></textarea>
    </div>
    
    <div class="input-group">
        <label for="enhanceInstructions">📝 What Should Be Added/Enhanced?</label>
        <textarea id="enhanceInstructions" placeholder="Describe what's missing or needs to be added. Examples:
        
- Add more evidence and examples in paragraph 3
- Need deeper analysis of the economic impacts
- Missing counterarguments and rebuttals
- Introduction needs stronger hook and thesis
- Conclusion lacks synthesis of main points
- Need more specific scientific data
- Add theoretical framework discussion
- Require more critical evaluation
        
Be specific about what gaps need filling..." style="min-height: 350px;"></textarea>
    </div>
    
    <div class="input-group">
        <label for="enhanceSubject">📚 Subject/Field:</label>
        <select id="enhanceSubject">
            <option value="general">General Academic</option>
            <option value="biology">Biology</option>
            <option value="chemistry">Chemistry</option>
            <option value="physics">Physics</option>
            <option value="mathematics">Mathematics</option>
            <option value="history">History</option>
            <option value="literature">Literature/English</option>
            <option value="psychology">Psychology</option>
            <option value="sociology">Sociology</option>
            <option value="business">Business</option>
            <option value="economics">Economics</option>
        </select>
    </div>
    
    <div class="input-group" style="padding: 15px; background: #e7f3ff; border-radius: 8px; border: 1px solid #2196F3;">
        <label style="color: #1976D2; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.2em;">💡</span>
            <span>ENHANCEMENT FEATURES:</span>
        </label>
        <ul style="margin: 10px 0 0 25px; color: #1565C0; line-height: 1.8;">
            <li>AI identifies gaps and adds missing information</li>
            <li>Maintains your original writing style and voice</li>
            <li>Integrates additions seamlessly</li>
            <li>Marks new content with [ADDED] tags so you can see changes</li>
            <li>Ensures full marks quality with complete coverage</li>
            <li>100% undetectable human writing throughout</li>
        </ul>
    </div>
</div>

        <div class="button-container">
            <button class="generate-btn" id="generateBtn">🚀 GENERATE HUMAN CONTENT</button>
            <button class="clear-btn" id="clearBtn">🗑️ CLEAR ALL</button>
        </div>

        <div class="output-section">
            <button class="copy-btn" id="copyBtn" style="display: none;">📋 COPY TEXT</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="loading-text" id="loadingText">🚀 GENERATING AUTHENTIC HUMAN CONTENT</p>
                <p class="loading-subtext" id="loadingSubtext">Creating naturally human text with zero AI patterns...</p>
            </div>
            <div class="output-content" id="output"></div>
        </div>

        <div class="human-score" id="humanScore"></div>

<!-- Chat History Section -->
        <div class="chat-history-section" style="margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 2px solid #dee2e6;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin-right:  30px; color: #2c3e50; font-size: 1.3em;">📜 Chat History</h3>
                <button id="clearHistoryBtn" style="padding: 8px 16px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em;">🗑️ Clear History</button>
            </div>
            <div id="chatHistoryList" style="max-height: 400px; overflow-y: auto;">
                <!-- History items will be inserted here -->
            </div>
            <p id="noHistory" style="text-align: center; color: #6c757d; padding: 40px; display: none;">No chat history yet. Generate or humanize content to start!</p>
        </div>

        <div class="stats">         
            <div class="stat-item">
                <div class="stat-value" id="outputWords">0</div>
                <div class="stat-label">Words Generated</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="outputChars">0</div>
                <div class="stat-label">Characters</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="sentences">0</div>
                <div class="stat-label">Sentences</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="paragraphs">0</div>
                <div class="stat-label">Paragraphs</div>
            </div>
        </div>
    </div>

  <script>
// =====================================================
// CONTENT TYPE & SUBJECT DEFINITIONS
// =====================================================
// =====================================================
// API KEY ROTATION SYSTEM
// =====================================================
let apiKeys = [];
let currentKeyIndex = 0;
let requestCount = 0;

// Initialize API keys from input (comma-separated)
function initializeApiKeys() {
    const keyInput = apiKeyInput.value.trim();
    
    if (!keyInput) {
        apiKeys = [];
        return;
    }
    
    // Split by comma and clean up each key
    const keys = keyInput.split(',').map(k => k.trim()).filter(k => k.length > 0);
    
    apiKeys = keys.map(key => ({
        key: key,
        requests: 0,
        errors: 0,
        lastUsed: null
    }));
    
    currentKeyIndex = 0;
    console.log(`✅ Initialized ${apiKeys.length} API key(s) for rotation`);
}

// Get next API key (round-robin rotation)
function getNextApiKey() {
    if (apiKeys.length === 0) {
        initializeApiKeys();
    }
    
    if (apiKeys.length === 0) {
        throw new Error('No API keys available');
    }
    
    // Get current key
    const currentKey = apiKeys[currentKeyIndex];
    currentKey.requests++;
    currentKey.lastUsed = new Date().toISOString();
    requestCount++;
    
    console.log(`🔑 Using API key ${currentKeyIndex + 1}/${apiKeys.length} (Request #${currentKey.requests})`);
    
    // Rotate to next key for next request
    currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
    
    return currentKey.key;
}

// Mark key as failed (for error handling)
function markKeyError(keyUsed) {
    const keyObj = apiKeys.find(k => k.key === keyUsed);
    if (keyObj) {
        keyObj.errors++;
        console.warn(`⚠️ Error on key: Request #${keyObj.requests}, Total errors: ${keyObj.errors}`);
    }
}

// Get rotation statistics
function getRotationStats() {
    if (apiKeys.length === 0) {
        return {
            totalKeys: 0,
            totalRequests: 0,
            keysStats: []
        };
    }
    
    return {
        totalKeys: apiKeys.length,
        totalRequests: requestCount,
        keysStats: apiKeys.map((k, i) => ({
            index: i + 1,
            requests: k.requests,
            errors: k.errors,
            lastUsed: k.lastUsed
        }))
    };
}

// Display rotation stats in console
function logRotationStats() {
    const stats = getRotationStats();
    console.log('📊 API Key Rotation Statistics:');
    console.log(`   Total Keys: ${stats.totalKeys}`);
    console.log(`   Total Requests: ${stats.totalRequests}`);
    stats.keysStats.forEach(k => {
        console.log(`   Key ${k.index}: ${k.requests} requests, ${k.errors} errors`);
    });
}
      
   const contentTypes = {
    journalism: {
        'news': '📰 News Article',
        'investigative': '🔍 Investigative Journalism',
        'feature': '📝 Feature Article',
        'editorial': '💭 Editorial/Opinion',
        'breaking': '⚡ Breaking News',
        'analysis': '📊 News Analysis',
        'interview': '🎤 Interview Article',
        'press-release': '📢 Press Release'
    },
    academic: {
        'essay': '📖 Academic Essay',
        'research': '🔬 Research Report',
        'analytical': '📈 Analytical Essay',
        'argumentative': '⚖️ Argumentative Essay',
        'comparative': '🔄 Comparative Essay',
        'literature': '📚 Literature Review',
        'thesis': '🎓 Thesis/Dissertation',
        'case-study': '📋 Case Study',
        'med-reflective': '🎓 MEd Reflective Essay',
        'med-research': '📚 MEd Research Paper',
        'med-literature-review': '📖 MEd Literature Review',
        'med-action-research': '🔬 MEd Action Research',
        'med-critical-analysis': '💭 MEd Critical Analysis',
        'med-professional-inquiry': '🎯 MEd Professional Inquiry Project'
    },
    business: {
        'email-formal': '✉️ Formal Business Email',
        'email-casual': '📧 Casual Professional Email',
        'proposal': '📄 Business Proposal',
        'report': '📊 Business Report',
        'memo': '📝 Memo/Internal Communication',
        'cover-letter': '💼 Cover Letter',
        'linkedin': '🔗 LinkedIn Post/Article',
        'presentation': '🎤 Presentation Script',
        'executive-summary': '📑 Executive Summary'
    },
    creative: {
        'blog': '📝 Blog Post',
        'social-media': '📱 Social Media Content',
        'ad-copy': '🎯 Advertisement Copy',
        'product-description': '🛍️ Product Description',
        'newsletter': '📬 Newsletter',
        'web-content': '🌐 Website Content',
        'script': '🎬 Video/Podcast Script',
        'story': '📖 Creative Story/Narrative'
    },
    technical: {
        'documentation': '📚 Technical Documentation',
        'user-guide': '📖 User Guide/Manual',
        'tutorial': '🎓 Tutorial/How-to',
        'whitepaper': '📄 White Paper',
        'api-docs': '⚙️ API Documentation',
        'technical-report': '🔧 Technical Report',
        'sop': '📋 Standard Operating Procedure',
        'specification': '📐 Technical Specification'
    }
};

const academicSubjects = {
    'biology': '🧬 Biology',
    'chemistry': '⚗️ Chemistry',
    'physics': '⚛️ Physics',
    'mathematics': '📐 Mathematics',
    'history': '📜 History',
    'geography': '🌍 Geography',
    'legal-studies': '⚖️ Legal Studies',
    'human-movement': '🏃 Human Movement Science',
    'psychology': '🧠 Psychology',
    'sociology': '👥 Sociology',
    'economics': '💰 Economics',
    'political-science': '🏛️ Political Science',
    'literature': '📚 Literature/English',
    'philosophy': '💭 Philosophy',
    'environmental-science': '🌱 Environmental Science',
    'computer-science': '💻 Computer Science',
    'engineering': '⚙️ Engineering',
    'medicine': '⚕️ Medicine/Health Sciences',
    'business': '💼 Business Studies',
    'art-history': '🎨 Art History',
    'music': '🎵 Music',
    'languages': '🗣️ Languages/Linguistics',
    'anthropology': '🗿 Anthropology',
    'education': '🎓 Education'
};

// --- NEW: canonical questionType templates (structure + required sections) ---
const questionTypes = {
    'explain': {
        short: 'Explain',
        template: [
            'PRECISE DEFINITION: State the concept with field-specific terminology and scope boundaries',
            'MECHANISTIC BREAKDOWN: Explain underlying mechanisms, processes, or principles using discipline-appropriate models',
            'CAUSAL RELATIONSHIPS: Show how components interact and why phenomena occur (not just what happens)',
            'CONCRETE EXEMPLIFICATION: Provide 2-3 specific, relevant examples demonstrating the concept in action',
            'BROADER SIGNIFICANCE: Connect to larger theoretical frameworks, practical applications, or implications',
            'SYNTHESIS: Integrate understanding into coherent takeaway that advances beyond surface description'
        ],
        fieldRequirements: {
            biology: 'Explain molecular mechanisms, cellular processes, physiological systems. Use terms like: substrate specificity, enzyme kinetics, homeostatic regulation, gene expression, signal transduction pathways, allosteric modulation',
            chemistry: 'Explain bonding theories, reaction mechanisms, thermodynamics, kinetics. Use terms like: electron configuration, orbital hybridization (sp3, sp2, sp), reaction coordinate diagrams, Le Chatelier\'s principle, equilibrium constant (Keq), activation energy (Ea)',
            physics: 'Explain forces, energy transformations, wave-particle duality, field theory. Use terms like: vector quantities, scalar quantities, conservation laws, field strength, quantum states, reference frames, relativity principles',
            mathematics: 'Explain derivations, proofs, theorems, axioms. Use terms like: necessary conditions, sufficient conditions, if and only if (iff), lemmas, corollaries, bijection, homeomorphism, isomorphism, convergence',
            history: 'Explain causation, context, contingency, historiography. Use terms like: primary sources, secondary sources, historiographical debate, periodization, structural factors, agency vs structure, longue durée',
            economics: 'Explain market mechanisms, economic theories, models. Use terms like: elasticity of demand, marginal utility, equilibrium price, externalities, asymmetric information, market failure, deadweight loss'
        }
    },
    
    'analyse': {
        short: 'Analyse',
        template: [
            'ESTABLISH ANALYTICAL FRAMEWORK: Define criteria, lens, or methodology for analysis (must be theory-driven or evidence-based)',
            'SYSTEMATIC DECOMPOSITION: Break subject into constituent elements, variables, or dimensions with precision',
            'CRITICAL EXAMINATION: Evaluate each component using evidence, logic, and disciplinary standards—identify patterns and anomalies',
            'RELATIONAL PATTERNS: Reveal relationships, correlations, causations, or contradictions between elements',
            'SYNTHESIS & INTERPRETATION: Integrate findings to generate insight that transcends descriptive observation',
            'IMPLICATIONS & LIMITATIONS: Discuss what analysis reveals, what remains uncertain, boundary conditions, and why findings matter'
        ],
        fieldRequirements: {
            biology: 'Analyze experimental data, statistical patterns, evolutionary relationships. Use: p-values, confidence intervals, control variables, confounding factors, phylogenetic analysis, phenotypic variation',
            chemistry: 'Analyze reaction mechanisms, spectroscopic data, molecular structures. Use: rate laws, reaction orders, equilibrium calculations, NMR/IR/MS spectroscopy, orbital symmetry rules, stereochemistry',
            literature: 'Analyze themes, symbols, narrative structure, authorial choices, literary devices. Use: close reading, textual evidence, literary theory (feminist, Marxist, postcolonial, etc.), intertextuality',
            political_science: 'Analyze power structures, policy outcomes, institutional behavior. Use: comparative method, case studies, rational choice theory, institutionalism, discourse analysis',
            business: 'Analyze market data, financial statements, strategic positioning. Use: SWOT analysis, Porter\'s Five Forces, financial ratios (ROI, ROE, P/E), break-even analysis, market segmentation'
        }
    },
    
    'compare': {
        short: 'Compare/Contrast',
        template: [
            'ESTABLISH BASIS FOR COMPARISON: Define specific criteria, dimensions, or variables being compared (must be explicit and justified)',
            'SYSTEMATIC SIMILARITIES: Identify shared features, characteristics, or patterns with specific evidence for each point',
            'SYSTEMATIC DIFFERENCES: Identify contrasting features, divergent outcomes, or distinct mechanisms with evidence',
            'ANALYTICAL DEPTH: Explain WHY similarities/differences exist—causal factors, historical contexts, underlying principles, structural constraints',
            'RELATIVE EVALUATION: Assess comparative strengths, weaknesses, advantages, limitations, trade-offs',
            'INTEGRATED CONCLUSION: Synthesize comparison into meaningful insight about relationships, hierarchies, conditions, or contexts'
        ],
        structure: 'Use point-by-point comparison (alternating between subjects for each criterion) for closely related subjects. Use block comparison (all of Subject A, then all of Subject B) for distinct subjects. NEVER just list—always analyze significance of each comparison point.'
    },
    
    'evaluate': {
        short: 'Evaluate',
        template: [
            'EVALUATION CRITERIA: Establish explicit, justified standards (effectiveness, validity, reliability, coherence, impact, feasibility, ethics)',
            'EVIDENCE MARSHALLING: Present comprehensive, relevant evidence for each criterion—both quantitative and qualitative where appropriate',
            'STRENGTHS ASSESSMENT: Identify what works well, what succeeds, what is valid—supported by specific examples and reasoning',
            'LIMITATIONS ASSESSMENT: Identify weaknesses, gaps, failures, contradictions, or methodological issues with evidence',
            'WEIGHING & JUDGMENT: Synthesize assessment into overall evaluative judgment with clear, transparent justification for weighting',
            'ALTERNATIVE CONSIDERATIONS: Discuss how different criteria, perspectives, or contexts might alter evaluation—acknowledge nuance'
        ],
        rigor: 'Evaluations must be evidence-based, balanced, and fair. Acknowledge complexity and trade-offs. Avoid simplistic "good/bad" binary judgments without sophisticated justification. Consider both intrinsic merit and contextual appropriateness.'
    },
    
    'discuss': {
        short: 'Discuss',
        template: [
            'ESTABLISH SCOPE: Define boundaries of discussion, key questions at stake, and what requires exploration',
            'MULTIPLE PERSPECTIVES: Present 2-4 distinct viewpoints, theories, or positions with evidence and reasoning for each',
            'CRITICAL ENGAGEMENT: Analyze strengths and weaknesses of each perspective—don\'t just describe, evaluate',
            'DEBATE SYNTHESIS: Identify areas of consensus, irreconcilable differences, and productive tensions between views',
            'REASONED POSITION: Articulate your own reasoned stance while acknowledging complexity and counterarguments',
            'UNRESOLVED QUESTIONS: Identify what remains contested, unknown, or worthy of further investigation—intellectual humility'
        ],
        balance: 'Discussion must demonstrate understanding of multiple views before taking a position. Engage with strongest versions of opposing arguments (steel man, not straw man).'
    },
    
    'argue': {
        short: 'Argue',
        template: [
            'THESIS: Clear, specific, defensible claim that takes a position (not description, not question)',
            'ARGUMENT 1 + EVIDENCE: First supporting reason with specific examples, data, logical reasoning, or authoritative sources',
            'ARGUMENT 2 + EVIDENCE: Second supporting reason (distinct from first) with substantiation',
            'ARGUMENT 3 + EVIDENCE: Third supporting reason (if needed for complexity and depth)',
            'COUNTERARGUMENT + REBUTTAL: Acknowledge strongest opposing view and refute with evidence, logic, or demonstration of limited applicability',
            'CONCLUSION: Reinforce thesis by synthesizing arguments and showing implications of accepting your position'
        ],
        logic: 'Use valid reasoning patterns: deductive (premises → necessary conclusion), inductive (evidence → probable generalization), or abductive (inference to best explanation). Avoid logical fallacies: ad hominem, straw man, false dichotomy, circular reasoning, hasty generalization, post hoc ergo propter hoc.'
    }
};

// --- NEW: helper to infer subject when user doesn't supply one (light heuristic) ---
function inferSubjectFromText(text) {
    if (!text || typeof text !== 'string') return null;
    const lower = text.toLowerCase();

    // simple keyword-based inference (keeps it deterministic and minimal)
    const subjectKeywords = {
        'biology': ['cell', 'photosynthesis', 'organism', 'dna', 'evolution', 'enzyme'],
        'chemistry': ['molecule', 'acid', 'base', 'reaction', 'stoichiometry', 'ph'],
        'physics': ['force', 'energy', 'momentum', 'quantum', 'voltage', 'thermodynamics'],
        'mathematics': ['integral', 'derivative', 'algebra', 'geometry', 'statistic', 'probability'],
        'history': ['war', 'empire', 'revolution', 'treaty', 'colony', 'ancient'],
        'geography': ['climate', 'map', 'terrain', 'river', 'mountain', 'urban'],
        'computer-science': ['algorithm', 'data structure', 'api', 'bug', 'software', 'model', 'ml', 'ai'],
        'economics': ['market', 'inflation', 'gdp', 'supply', 'demand', 'fiscal'],
        'political-science': ['election', 'government', 'policy', 'constitution', 'diplomacy'],
        'psychology': ['cognitive', 'behaviour', 'memory', 'psychology', 'mental', 'therapy']
        // add more heuristics as you wish
    };

    for (const key of Object.keys(subjectKeywords)) {
        const kws = subjectKeywords[key];
        for (const k of kws) {
            if (lower.includes(k)) return key;
        }
    }
    return null;
}

// --- NEW: function returning succinct subject-specific + question-type instructions to inject into the prompt ---
function getSubjectSpecificInstructions(subjectKey, questionTypeKey) {
    // If subjectKey is null, caller should have attempted inference before calling.
    const subjectLabel = subjectKey && academicSubjects[subjectKey] ? academicSubjects[subjectKey] : (subjectKey || 'General');
    const questionTemplate = questionTypes[questionTypeKey];

    // Base subject constraints (short, high-signal)
    const subjectConstraints = {
        'biology': 'Use biological terminology precisely (e.g., cell types, ecological terms). Where quantitative data appears, preserve units and magnitudes.',
        'chemistry': 'Preserve formulas, chemical names, and units. Prefer clear mechanism explanations when describing reactions.',
        'physics': 'Keep units, signs, and equations intact. Explain mechanisms and assumptions behind models (e.g., frictionless, ideal gas).',
        'mathematics': 'Preserve notation. Show key steps concisely; if a proof structure is required, give a clear lemma → proof flow.',
        'history': 'Keep dates, names, and locales unchanged. Provide primary/secondary source context where relevant.',
        'computer-science': 'Preserve API names, code identifiers, and complexity notation. If code sample requested, include minimal runnable snippet.',
        'economics': 'Preserve numerical indicators, percentages, and definitions of terms (e.g., CPI, GDP). Be explicit about assumptions.',
        'political-science': 'Preserve names, offices, and dates. Distinguish between normative claims and empirical evidence.',
        'psychology': 'Use precise psychological terms and note study types (e.g., RCT, longitudinal) when citing evidence.'
        // default for other keys will be concise generic instruction
    };

    const subjInstr = subjectConstraints[subjectKey] || `When discussing ${subjectLabel}, preserve domain-specific terms and any quantitative or named references exactly.`;

    // Build the instructions block
    const lines = [];
    lines.push(`SUBJECT: ${subjectLabel}.`);
    lines.push(`GUIDELINES: ${subjInstr}`);
    if (questionTemplate) {
        lines.push(`STRUCTURE (${questionTemplate.short}):`);
        for (const step of questionTemplate.template) lines.push(`- ${step}`);
    } else {
        lines.push(`STRUCTURE: Provide a clear thesis, 2–4 supporting points with evidence, and a concise conclusion.`);
    }

    // A short, deterministic phrasing to be inserted into the main prompt
    return lines.join(' ');
}
// =====================================================
// DOM ELEMENTS
// =====================================================
const textTypeOverride = document.getElementById('textTypeOverride');
      const apiKeyInput = document.getElementById('apiKey');
const topicInput = document.getElementById('topic');
const keywordsInput = document.getElementById('keywords');
const categorySelect = document.getElementById('category');
const modeSelect = document.getElementById('mode');
const wordCountInput = document.getElementById('wordCount');
const intensitySlider = document.getElementById('intensity');
const intensityValue = document.getElementById('intensityValue');
const generateBtn = document.getElementById('generateBtn');
const clearBtn = document.getElementById('clearBtn');
const output = document.getElementById('output');
const loading = document.getElementById('loading');
const loadingText = document.getElementById('loadingText');
const loadingSubtext = document.getElementById('loadingSubtext');
const errorDiv = document.getElementById('error');
const successDiv = document.getElementById('success');
const copyBtn = document.getElementById('copyBtn');
const humanScore = document.getElementById('humanScore');
const generateModeBtn = document.getElementById('generateMode');
const humanizeModeBtn = document.getElementById('humanizeMode');
const generateInputs = document.getElementById('generateInputs');
const humanizeInputs = document.getElementById('humanizeInputs');
const existingTextInput = document.getElementById('existingText');
const autoDetectBtn = document.getElementById('autoDetectBtn');
const manualSelectBtn = document.getElementById('manualSelectBtn');
const detectionModeDesc = document.getElementById('detectionModeDesc');

// =====================================================
// STATE MANAGEMENT
// =====================================================
let currentMode = 'generate';
let detectionMode = 'automatic';
let chatHistory = [];

// =====================================================
// UTILITY FUNCTIONS
// =====================================================
function countWords(text) {
    if (!text || text.trim() === '') return 0;
    return text.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function updateStats() {
    const text = output.textContent;
    const words = countWords(text);
    const chars = text.length;
    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
    const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0).length;
    
    document.getElementById('outputWords').textContent = words;
    document.getElementById('outputChars').textContent = chars;
    document.getElementById('sentences').textContent = sentences;
    document.getElementById('paragraphs').textContent = paragraphs;
}

// =====================================================
// CATEGORY CHANGE HANDLER
// =====================================================
// =====================================================
// CATEGORY CHANGE HANDLER - FIXED
// =====================================================
function updateModeOptions() {
    const category = categorySelect.value;
    const modes = contentTypes[category];
    
    // Clear existing options
    modeSelect.innerHTML = '';
    
    // Add new options based on selected category
    for (const [value, label] of Object.entries(modes)) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        modeSelect.appendChild(option);
    }
    
    console.log(`Updated mode options for category: ${category}`);
}

// Make sure the event listener is properly attached
categorySelect.addEventListener('change', updateModeOptions);

// Initialize on page load
updateModeOptions();
// =====================================================
// INTENSITY SLIDER
// =====================================================
intensitySlider.addEventListener('input', (e) => {
    const value = e.target.value;
    const labels = ['NATURAL', 'ENHANCED', 'ULTRA-HUMAN'];
    intensityValue.textContent = labels[value - 1];
});

// =====================================================
// MODE TOGGLE (Generate vs Humanize)
// =====================================================
generateModeBtn.addEventListener('click', () => {
    currentMode = 'generate';
    generateModeBtn.classList.add('active');
    generateModeBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
    generateModeBtn.style.color = 'white';
    humanizeModeBtn.classList.remove('active');
    humanizeModeBtn.style.background = 'transparent';
    humanizeModeBtn.style.color = '#495057';
    enhanceModeBtn.classList.remove('active');
    enhanceModeBtn.style.background = 'transparent';
    enhanceModeBtn.style.color = '#495057';
    
    generateInputs.style.display = 'block';
    humanizeInputs.style.display = 'none';
    enhanceInputs.style.display = 'none';
    generateBtn.innerHTML = '🚀 GENERATE HUMAN CONTENT';
});

humanizeModeBtn.addEventListener('click', () => {
    currentMode = 'humanize';
    humanizeModeBtn.classList.add('active');
    humanizeModeBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
    humanizeModeBtn.style.color = 'white';
    generateModeBtn.classList.remove('active');
    generateModeBtn.style.background = 'transparent';
    generateModeBtn.style.color = '#495057';
    enhanceModeBtn.classList.remove('active');
    enhanceModeBtn.style.background = 'transparent';
    enhanceModeBtn.style.color = '#495057';
    
    generateInputs.style.display = 'none';
    humanizeInputs.style.display = 'block';
    enhanceInputs.style.display = 'none';
    generateBtn.innerHTML = '✨ HUMANIZE TEXT';
});

      

      

// =====================================================
// DETECTION MODE TOGGLE
// =====================================================
autoDetectBtn.addEventListener('click', () => {
    detectionMode = 'automatic';
    autoDetectBtn.style.background = 'linear-gradient(135deg, #28a745, #218838)';
    autoDetectBtn.style.color = 'white';
    manualSelectBtn.style.background = 'transparent';
    manualSelectBtn.style.color = '#495057';
    detectionModeDesc.textContent = 'AI automatically detects subject, question type, and format';
});

manualSelectBtn.addEventListener('click', () => {
    detectionMode = 'manual';
    manualSelectBtn.style.background = 'linear-gradient(135deg, #28a745, #218838)';
    manualSelectBtn.style.color = 'white';
    autoDetectBtn.style.background = 'transparent';
    autoDetectBtn.style.color = '#495057';
    detectionModeDesc.textContent = 'You manually select category, type, and word count';
});

// =====================================================
// ADVANCED PROMPT GENERATION
// =====================================================
// =====================================================
// ULTRA-AGGRESSIVE ANTI-AI DETECTION PROMPT
// =====================================================
const enhanceModeBtn = document.getElementById('enhanceMode');
const enhanceInputs = document.getElementById('enhanceInputs');
const contentToEnhance = document.getElementById('contentToEnhance');
const enhanceInstructions = document.getElementById('enhanceInstructions');
const enhanceSubject = document.getElementById('enhanceSubject');

// Enhance mode button click
// Enhance mode button click
enhanceModeBtn.addEventListener('click', () => {
    currentMode = 'enhance';
    
    // Style active button
    enhanceModeBtn.classList.add('active');
    enhanceModeBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
    enhanceModeBtn.style.color = 'white';
    
    // Reset other buttons
    generateModeBtn.classList.remove('active');
    generateModeBtn.style.background = 'transparent';
    generateModeBtn.style.color = '#495057';
    humanizeModeBtn.classList.remove('active');
    humanizeModeBtn.style.background = 'transparent';
    humanizeModeBtn.style.color = '#495057';
    
    // Show/hide inputs
    generateInputs.style.display = 'none';
    humanizeInputs.style.display = 'none';
    enhanceInputs.style.display = 'block';
    
    generateBtn.innerHTML = '🎯 ENHANCE & COMPLETE CONTENT';
});

// =====================================================
// UPDATE GENERATE BUTTON TO HANDLE ENHANCE MODE
// =====================================================

// Add this case in your generateBtn click handler (after humanize case):

const contentTypeTemplates = {
  journalism: {
    'news': {
      tone: 'urgent, factual, immediate',
      requiredSections: [
        'Lede (who/what/when/where/why in 1-2 sentences)',
        'Key facts in descending importance',
        'Direct quotes from named sources',
        'Background context',
        'Impact/consequences',
        'Next developments'
      ],
      sentenceLength: 'Average 15-20 words. Vary between 8-25 words. Clarity over complexity.',
      vocabulary: 'Precise journalism terms: confirmed, reported, according to, officials stated, data shows, sources reveal, investigation found, records indicate, witnesses described. Attribution essential.',
      structure: 'INVERTED PYRAMID strictly. Most important info first. Each paragraph complete thought. Can cut from bottom without losing core story. Active voice predominates. Attribution for all claims.'
    },
    
    'investigative': {
      tone: 'revelatory, detailed, evidence-heavy, methodologically transparent',
      requiredSections: [
        'Hook (compelling finding or revelation)',
        'Core discovery/revelation stated clearly',
        'Evidence trail (documents, sources, data)',
        'Context and broader significance',
        'Methodology transparency',
        'Implications and impact',
        'Response from subjects investigated'
      ],
      vocabulary: 'Forensic language: documents reveal, investigation found, records show, sources confirmed, obtained by, verified through, cross-referenced, whistleblower disclosed, internal memos indicate',
      structure: 'Lead with strongest finding. Build case through layered evidence. Show your work—methodology transparent. Multiple named and anonymous sources. Document citations. Timeline when relevant.'
    },
    
    'feature': {
      tone: 'narrative, immersive, character-driven, literary',
      requiredSections: [
        'Scene-setting opening (anecdote, moment, vivid description)',
        'Introduce key subjects/characters with detail',
        'Broaden to larger context/issue',
        'Development through scenes, quotes, and exposition',
        'Analysis and interpretation woven in',
        'Resonant closing that echoes opening theme'
      ],
      vocabulary: 'Sensory details, specific nouns, active verbs. Literary devices: metaphor, symbolism, foreshadowing. Terms like: describes, recalls, reflects, observes, remembers, gestures, pauses.',
      structure: 'Narrative arc with rising action. Scenes alternate with exposition. Show don\'t tell. Character development through action and dialogue. Thematic unity. Emotional resonance. Subtext.'
    }
  },

  academic: {
    'essay': {
      tone: 'analytical, argued, sophisticated, evidence-driven',
      requiredSections: [
        'Introduction: hook → context → thesis statement (clear, arguable, specific)',
        'Body paragraph 1: topic sentence → context → evidence → analysis → link to thesis',
        'Body paragraph 2: distinct point → evidence → analysis → link',
        'Body paragraph 3: third point → evidence → analysis → link',
        'Counterargument paragraph (acknowledge opposing view, then refute)',
        'Conclusion: restate thesis (new words) → synthesize arguments → broader implications'
      ],
      vocabulary: 'Academic discourse markers: furthermore, moreover, conversely, nevertheless, consequently, notwithstanding, demonstrates, illustrates, exemplifies, underscores, elucidates. Field-specific terminology MANDATORY.',
      structure: 'Thesis must be arguable and specific (not fact or question). Each paragraph develops ONE idea. Topic sentences roadmap the paragraph. Evidence must be analyzed deeply, not just cited. Link back to thesis explicitly at paragraph end.',
      paragraphStructure: '5-8 sentences per paragraph. PEEL/TEEL format: Point (topic sentence/claim) → Evidence (quote, data, example with citation) → Explanation (analyze how evidence supports point) → Link (connect back to thesis).'
    },
    
    'research': {
      tone: 'objective, methodical, technical, replicable',
      requiredSections: [
        'Abstract (150-250 words): purpose, method, key findings, significance',
        'Introduction: research question, literature review, hypothesis/research aims',
        'Methodology: participants/sample (n=X), materials, procedure (replicable detail), analysis plan',
        'Results: quantitative/qualitative findings, statistical analysis, tables/figures with captions',
        'Discussion: interpretation of findings, theoretical implications, practical applications, limitations, directions for future research',
        'Conclusion: concise summary, take-home message',
        'References: properly formatted citations (APA/MLA/Chicago)'
      ],
      vocabulary: 'Methodological precision: participants (n=156, M_age = 22.4, SD = 3.1), Likert scale (1-7), correlation coefficient (r = .45), p-value (p < .001), effect size (d = 0.65), qualitative coding, thematic analysis, regression analysis, ANOVA, confounding variables, operational definition',
      structure: 'IMRaD format (Introduction, Method, Results, and Discussion) strictly. Past tense for methods/results. Present tense for established knowledge and discussion of findings. Passive voice acceptable in methods section. Results section reports data WITHOUT interpretation (save interpretation for discussion).',
      statisticalReporting: 'Report exact statistics with precision: M = 4.35, SD = 0.89, t(48) = 3.21, p = .002, Cohen\'s d = 0.65. Include confidence intervals: 95% CI [2.14, 3.87]. Report effect sizes always.'
    },
    
    'lab-report': {
      tone: 'objective, precise, technical, replicable',
      requiredSections: [
        'Title: specific and descriptive (include key variables)',
        'Abstract: purpose, method, key results, conclusion (150-200 words)',
        'Introduction: theory, previous research, hypothesis with justification',
        'Method: apparatus (with model numbers), materials, procedure (step-by-step, replicable)',
        'Results: data tables, calculations shown, graphs with error bars',
        'Discussion: interpretation, error analysis (systematic vs random), sources of uncertainty, improvements, conclusion',
        'References: properly cited sources'
      ],
      vocabulary: 'Scientific precision: apparatus, titration, calibration, systematic error, random error, percentage uncertainty (±X%), anomalous results, directly proportional, inversely proportional, null hypothesis, independent variable, dependent variable, control variables',
      structure: 'Passive voice in method ("50mL was measured" not "I measured"). Data tables must have: title, column headings with units, consistent decimal places. Graphs must have: title, labeled axes with units, line of best fit, error bars if applicable. Error analysis mandatory—discuss both systematic and random errors.'
    }
  },

  business: {
    'proposal': {
      tone: 'persuasive, structured, benefit-focused, ROI-driven',
      requiredSections: [
        'Executive Summary: problem, solution, benefits, costs (1 page max)',
        'Problem Statement: current situation, challenges, quantified costs of inaction',
        'Proposed Solution: detailed description, methodology, implementation approach',
        'Benefits and Value Proposition: quantified benefits, ROI analysis, competitive advantage',
        'Implementation Plan: timeline with milestones, resource requirements, responsibilities',
        'Budget: itemized costs, pricing structure, payment terms',
        'Risk Assessment and Mitigation: identify risks and contingencies',
        'Conclusion and Call to Action: next steps, decision timeline',
        'Appendices: supporting data, case studies, technical specifications, references'
      ],
      vocabulary: 'Persuasive business language: drive revenue growth, enhance operational efficiency, maximize ROI, strategic advantage, proven methodology, measurable outcomes, competitive differentiation, scalability, cost-benefit ratio, value proposition, synergies',
      structure: 'Problem-solution format with emphasis on quantification. Use $, %, and time metrics throughout. Include charts/tables for financial data. Case studies demonstrate credibility. Address objections proactively. Make ROI crystal clear: "Implementation costs $50K but saves $200K annually."'
    },
    
    'email-formal': {
      tone: 'courteous, concise, purposeful, professional',
      requiredSections: [
        'Subject line: specific and informative (8-12 words)',
        'Salutation: Dear [Title] [Last Name], (research correct name and title)',
        'Opening: state purpose immediately (1-2 sentences max)',
        'Body: details, context, or request (2-4 sentences, use paragraph breaks)',
        'Closing: clear call to action or next steps',
        'Sign-off: Sincerely/Best regards/Kind regards, [Full Name, Title, Contact Info]'
      ],
      vocabulary: 'Professional courtesy: I am writing to inquire about, I would appreciate your guidance on, please find attached, kindly advise, at your earliest convenience, thank you for your consideration, I look forward to your response',
      structure: 'Subject line must be specific: "Meeting Request: Q2 Budget Review" not just "Meeting". Keep email 150-250 words total. One email = one clear purpose. Use paragraph breaks for readability (not walls of text). Proofread meticulously—errors undermine credibility.'
    }
  },

  technical: {
    'tutorial': {
      tone: 'instructional, clear, step-by-step, supportive',
      requiredSections: [
        'Title: action-oriented ("How to X" or "Setting Up X")',
        'Introduction: what will be accomplished, who this is for, time required',
        'Prerequisites: required knowledge, tools, software versions, accounts',
        'Step 1: action in imperative ("Click...", "Navigate to...", "Enter...")',
        'Step 2: single action with expected outcome ("You should see...")',
        'Continue steps: one action per numbered step',
        'Verification: how to confirm success',
        'Troubleshooting: common errors and solutions',
        'Next steps: what to learn/do next'
      ],
      vocabulary: 'Instructional language: click, navigate to, select, enter, copy, paste, install, configure, verify, confirm. Technical terms: API endpoint, authentication token, dependency, repository, command line interface, parameter, variable',
      structure: 'Imperative mood ("Do X" not "You should do X"). Numbered steps with single action each. Screenshots with annotations where helpful. Code blocks properly formatted with syntax highlighting. Warning boxes for critical steps. Expected outcome after each step: "You should now see the dashboard loading."'
    },
    
    'api-docs': {
      tone: 'reference-style, unambiguous, complete, technical',
      requiredSections: [
        'Endpoint name and purpose',
        'HTTP Method (GET, POST, PUT, DELETE, PATCH)',
        'URL structure with parameters: /api/v1/users/{id}',
        'Authentication requirements',
        'Request parameters: name, type, required/optional, description',
        'Request body schema (JSON example)',
        'Response codes: 200, 201, 400, 401, 404, 500 with meanings',
        'Response body schema (JSON example)',
        'Error responses with examples',
        'Code examples in multiple languages (Python, JavaScript, cURL)'
      ],
      vocabulary: 'API terminology: endpoint, method, parameter, query string, request body, response body, status code, header, authentication, authorization, bearer token, JSON, XML, REST, payload, rate limiting',
      structure: 'Consistent formatting for all endpoints. Parameter tables: Name | Type | Required | Description. Actual code examples that work (not pseudocode). Error handling comprehensively documented. Version all endpoints (/api/v1/). Include rate limits and pagination info.'
    }
  }
};
// --- NEW: helper to resolve style instructions for a given content category & subkey ---
function getStyleForContentType(contentCategory = null, contentKey = null) {
  if (!contentCategory) return '';
  const cat = contentTypeTemplates[contentCategory];
  if (!cat) return '';
  // prefer specific subtype if exists, else default
  const subtype = contentKey && cat[contentKey] ? cat[contentKey] : cat.default;
  // produce a compact single-line instruction block
  const instr = [
    `CONTENT TYPE: ${contentCategory}${contentKey ? ' / ' + contentKey : ''}.`,
    `TONE: ${subtype.tone || 'balanced'}.`,
    `STRUCTURE PRIORITY: ${subtype.priority || 'thesis → body → conclusion'}.`,
    `REQUIRED SECTIONS: ${ (subtype.requiredSections || []).join(' | ') || 'Thesis; Evidence; Conclusion'}.`,
    `VOICE: ${subtype.voice || 'appropriate to genre'}.`
  ].join(' ');
  return instr;
}

      // --- ADD: detectContentTypeUsingTemplates (uses contentTypeTemplates) ---
// --- ENHANCED: detectContentTypeUsingTemplates with ULTRA-PRECISE detection ---
function detectContentTypeUsingTemplates(text, subject = null, templates = contentTypeTemplates) {
  if (!text || typeof text !== 'string') return { contentCategory: null, contentTypeKey: null, confidence: 0, evidence: [] };
  
  const lower = text.toLowerCase();
  const words = text.trim().split(/\s+/).length;
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  const avgSentenceLength = words / sentences.length;
  const evidence = [];

  // Helper: calculate structural signatures
  function getStructuralSignature(txt) {
    return {
      hasCitations: /\([A-Z][a-z]+,?\s+\d{4}\)|\[\d+\]|et al\.|ibid\./i.test(txt),
      hasQuotes: /"[^"]{20,}"|'[^']{20,}'/.test(txt),
      hasSections: /^(introduction|abstract|method|results|discussion|conclusion)/im.test(txt),
      hasDateline: /^[A-Z][A-Z\s]+,\s+[A-Z][a-z]+\s+\d{1,2}\s+[-–]\s+/.test(txt),
      hasByline: /^by\s+[A-Z][a-z]+\s+[A-Z][a-z]+/im.test(txt),
      hasStatistics: /\d+%|\d+\s+(percent|million|billion|thousand)|\$\d+|n\s*=\s*\d+/i.test(txt),
      hasTechnicalTerms: /\b(function|class|method|API|endpoint|parameter|algorithm|implementation)\b/i.test(txt),
      hasAcademicMarkers: /\b(furthermore|moreover|conversely|nevertheless|consequently|hypothesis|methodology|findings)\b/i.test(txt),
      hasJournalismMarkers: /\b(according to|officials|sources|reported|confirmed|witnesses|breaking)\b/i.test(txt),
      hasBusinessMarkers: /\b(stakeholders|ROI|strategy|revenue|growth|implementation|deliverables)\b/i.test(txt),
      hasImperatives: /^(click|navigate|enter|select|install|configure|open|run|type)\b/im.test(txt),
      hasBulletPoints: /^[\s]*[-•*]\s+/m.test(txt),
      hasNumberedSteps: /^[\s]*\d+\.\s+/m.test(txt),
      hasPersonalPronouns: /\b(I|we|our|my|you|your)\b/.test(txt),
      hasFormalSalutation: /^dear\s+[a-z]/i.test(txt) || /sincerely,|regards,|respectfully,/i.test(txt)
    };
  }

  const sig = getStructuralSignature(text);

  // ACADEMIC DETECTION (highest priority if citations present)
  if (sig.hasCitations || (sig.hasAcademicMarkers && !sig.hasJournalismMarkers)) {
    
    // Research paper detection
    if (sig.hasSections && /\b(abstract|methodology|method|results|participants|hypothesis|findings|limitations)\b/i.test(lower)) {
      if (/\b(n\s*=\s*\d+|p\s*[<>=]\s*\.?\d+|M\s*=\s*\d+|SD\s*=|correlation|ANOVA|regression|qualitative|thematic analysis)\b/i.test(text)) {
        evidence.push('research:statisticalAnalysis', 'research:methodologySection', 'research:IMRaDStructure');
        return { contentCategory: 'academic', contentTypeKey: 'research', confidence: 96, evidence };
      }
      evidence.push('research:abstractPresent', 'research:sectionsPresent');
      return { contentCategory: 'academic', contentTypeKey: 'research', confidence: 92, evidence };
    }

    // Lab report detection
    if (/\b(apparatus|procedure|materials|experiment|titration|measurement|uncertainty|error analysis|observation)\b/i.test(lower)) {
      evidence.push('labReport:experimentalTerms', 'labReport:procedureSection');
      return { contentCategory: 'academic', contentTypeKey: 'lab-report', confidence: 90, evidence };
    }

    // Literature review detection
    if (/\b(literature review|scholars argue|research demonstrates|studies reveal|consensus|meta-analysis|synthesis of|gap in literature)\b/i.test(lower)) {
      evidence.push('literatureReview:scholarlyLanguage', 'literatureReview:synthesisMarkers');
      return { contentCategory: 'academic', contentTypeKey: 'literature-review', confidence: 88, evidence };
    }

    // Thesis/dissertation detection
    if (words > 3000 && /\b(chapter|thesis|dissertation|research question|theoretical framework|significance of study)\b/i.test(lower)) {
      evidence.push('thesis:lengthIndicator', 'thesis:structuralMarkers');
      return { contentCategory: 'academic', contentTypeKey: 'thesis', confidence: 85, evidence };
    }

    // Default to essay if academic but no specific type
    if (sig.hasCitations) {
      evidence.push('essay:citationsPresent', 'essay:argumentativeStructure');
      return { contentCategory: 'academic', contentTypeKey: 'essay', confidence: 82, evidence };
    }
  }

  // JOURNALISM DETECTION
  if (sig.hasJournalismMarkers || sig.hasQuotes || sig.hasDateline || sig.hasByline) {
    
    // Breaking news detection
    if (/\b(breaking|developing|just in|latest|update|urgent|alert)\b/i.test(lower) && words < 500) {
      evidence.push('news:breakingKeywords', 'news:shortLength', 'news:urgentTone');
      return { contentCategory: 'journalism', contentTypeKey: 'breaking', confidence: 94, evidence };
    }

    // Investigative journalism detection
    if (/\b(investigation|documents reveal|obtained by|sources confirm|whistleblower|internal memo|records show|uncovered|expose)\b/i.test(lower) && words > 800) {
      evidence.push('investigative:forensicLanguage', 'investigative:documentEvidence', 'investigative:depth');
      return { contentCategory: 'journalism', contentTypeKey: 'investigative', confidence: 92, evidence };
    }

    // Feature article detection
    if (words > 600 && sig.hasQuotes && /\b(describes|recalls|remembers|reflects|observes|gestures|pauses)\b/i.test(lower)) {
      if (sentences[0] && sentences[0].length > 150) { // Long narrative opening
        evidence.push('feature:narrativeOpening', 'feature:characterDriven', 'feature:literaryDevices');
        return { contentCategory: 'journalism', contentTypeKey: 'feature', confidence: 90, evidence };
      }
    }

    // News analysis detection
    if (/\b(analysis|implications|consequences|factors|underlying|context|explains why|significance of)\b/i.test(lower) && sig.hasStatistics) {
      evidence.push('analysis:analyticalLanguage', 'analysis:dataSupport');
      return { contentCategory: 'journalism', contentTypeKey: 'analysis', confidence: 87, evidence };
    }

    // Interview article detection
    if ((text.match(/Q:|A:|Question:|Answer:/g) || []).length >= 4) {
      evidence.push('interview:QAFormat', 'interview:structuredDialogue');
      return { contentCategory: 'journalism', contentTypeKey: 'interview', confidence: 95, evidence };
    }

    // Editorial/Opinion detection
    if (/\b(I argue|we must|should|ought to|in my view|opinion|perspective|contend|believe)\b/i.test(lower) && !sig.hasCitations) {
      evidence.push('editorial:opinionMarkers', 'editorial:firstPerson', 'editorial:prescriptive');
      return { contentCategory: 'journalism', contentTypeKey: 'editorial', confidence: 86, evidence };
    }

    // Default to news
    evidence.push('news:journalisticConventions', 'news:objectiveTone');
    return { contentCategory: 'journalism', contentTypeKey: 'news', confidence: 80, evidence };
  }

  // BUSINESS COMMUNICATION DETECTION
  if (sig.hasBusinessMarkers || sig.hasFormalSalutation) {
    
    // Formal email detection
    if (sig.hasFormalSalutation && words < 300) {
      evidence.push('email:salutation', 'email:shortLength', 'email:professionalTone');
      return { contentCategory: 'business', contentTypeKey: 'email-formal', confidence: 93, evidence };
    }

    // Proposal detection
    if (/\b(executive summary|problem statement|proposed solution|implementation plan|budget|ROI|value proposition|deliverables)\b/i.test(lower)) {
      evidence.push('proposal:structuredSections', 'proposal:persuasiveLanguage', 'proposal:financialElements');
      return { contentCategory: 'business', contentTypeKey: 'proposal', confidence: 91, evidence };
    }

    // Business report detection
    if (/\b(table of contents|findings|recommendations|analysis|quarterly|year-over-year|performance metrics|KPI)\b/i.test(lower) && words > 500) {
      evidence.push('report:structuralSections', 'report:analyticalContent', 'report:dataPresentation');
      return { contentCategory: 'business', contentTypeKey: 'report', confidence: 89, evidence };
    }

    // Cover letter detection
    if (/\b(I am writing to apply|position|qualifications|experience|skills|resume|curriculum vitae|portfolio)\b/i.test(lower) && words < 600) {
      evidence.push('coverLetter:applicationContext', 'coverLetter:personalExperience', 'coverLetter:appropriateLength');
      return { contentCategory: 'business', contentTypeKey: 'cover-letter', confidence: 92, evidence };
    }

    // Memo detection
    if (/^(TO:|FROM:|DATE:|RE:|SUBJECT:)/im.test(text) || /\bmemo\b/i.test(lower)) {
      evidence.push('memo:headerFormat', 'memo:internalCommunication');
      return { contentCategory: 'business', contentTypeKey: 'memo', confidence: 94, evidence };
    }

    // LinkedIn post detection
    if (words < 300 && /\b(excited to announce|proud to share|thrilled|networking|connection|professional|career)\b/i.test(lower)) {
      evidence.push('linkedin:professionalSocial', 'linkedin:shortLength', 'linkedin:networkingLanguage');
      return { contentCategory: 'business', contentTypeKey: 'linkedin', confidence: 85, evidence };
    }
  }

  // TECHNICAL DOCUMENTATION DETECTION
  if (sig.hasTechnicalTerms || sig.hasImperatives || sig.hasNumberedSteps) {
    
    // Tutorial detection
    if (sig.hasNumberedSteps && sig.hasImperatives) {
      if (/\b(step \d+|how to|getting started|prerequisites|requirements|installation|setup)\b/i.test(lower)) {
        evidence.push('tutorial:stepByStep', 'tutorial:imperativeMood', 'tutorial:instructional');
        return { contentCategory: 'technical', contentTypeKey: 'tutorial', confidence: 94, evidence };
      }
    }

    // API documentation detection
    if (/\b(endpoint|GET|POST|PUT|DELETE|request|response|parameter|authentication|HTTP|JSON|REST|API)\b/i.test(lower)) {
      evidence.push('apiDocs:technicalTerms', 'apiDocs:httpMethods', 'apiDocs:referenceStyle');
      return { contentCategory: 'technical', contentTypeKey: 'api-docs', confidence: 95, evidence };
    }

    // User guide detection
    if (sig.hasImperatives && /\b(user guide|manual|instructions|overview|interface|navigation|features)\b/i.test(lower)) {
      evidence.push('userGuide:instructionalContent', 'userGuide:comprehensiveCoverage');
      return { contentCategory: 'technical', contentTypeKey: 'user-guide', confidence: 88, evidence };
    }

    // Technical specification detection
    if (/\b(specification|requirements|architecture|design|protocol|standard|compliance|version)\b/i.test(lower) && !sig.hasImperatives) {
      evidence.push('specification:technicalDetail', 'specification:formalStructure');
      return { contentCategory: 'technical', contentTypeKey: 'specification', confidence: 87, evidence };
    }

    // Whitepaper detection
    if (words > 1500 && /\b(abstract|technical overview|architecture|implementation|use cases|performance|scalability)\b/i.test(lower)) {
      evidence.push('whitepaper:technicalDepth', 'whitepaper:comprehensiveLength', 'whitepaper:authoritative');
      return { contentCategory: 'technical', contentTypeKey: 'whitepaper', confidence: 86, evidence };
    }
  }

  // CREATIVE WRITING DETECTION
  if (sig.hasPersonalPronouns && !sig.hasCitations && !sig.hasBusinessMarkers) {
    
    // Blog post detection
    if (words > 300 && words < 2000 && /\b(discover|learn|tips|guide|secrets|essential|ultimate|best|top \d+)\b/i.test(lower)) {
      if (sig.hasBulletPoints || sig.hasNumberedSteps) {
        evidence.push('blog:conversationalTone', 'blog:practicalContent', 'blog:listicleFormat');
        return { contentCategory: 'creative', contentTypeKey: 'blog', confidence: 88, evidence };
      }
    }

    // Social media detection
    if (words < 100 && (/\b(check out|follow|like|share|comment|link in bio|DM me)\b/i.test(lower) || /[#@]\w+/.test(text))) {
      evidence.push('socialMedia:shortLength', 'socialMedia:casualTone', 'socialMedia:hashtagsMentions');
      return { contentCategory: 'creative', contentTypeKey: 'social-media', confidence: 92, evidence };
    }

    // Ad copy detection
    if (words < 150 && /\b(buy now|order today|limited time|exclusive|guarantee|free|save|discount|don't miss)\b/i.test(lower)) {
      evidence.push('adCopy:persuasiveLanguage', 'adCopy:urgency', 'adCopy:CTA');
      return { contentCategory: 'creative', contentTypeKey: 'ad-copy', confidence: 90, evidence };
    }

    // Story/narrative detection
    if (words > 500 && /\b(once|suddenly|whispered|gazed|trembled|heart|shadow|dream)\b/i.test(lower)) {
      if (/["'].*?(said|asked|replied|whispered|shouted)/.test(text)) { // Dialogue present
        evidence.push('story:narrativeElements', 'story:dialogue', 'story:descriptiveLanguage');
        return { contentCategory: 'creative', contentTypeKey: 'story', confidence: 87, evidence };
      }
    }

    // Script detection
    if (/^[A-Z\s]+:/m.test(text) || /\(.*?\)/.test(text.substring(0, 200))) { // Character names or stage directions
      evidence.push('script:characterNames', 'script:dialogueFormat', 'script:stageDirections');
      return { contentCategory: 'creative', contentTypeKey: 'script', confidence: 91, evidence };
    }

    // Newsletter detection
    if (/\b(newsletter|subscribe|unsubscribe|this week|this month|roundup|digest)\b/i.test(lower)) {
      evidence.push('newsletter:periodicContent', 'newsletter:compiledFormat');
      return { contentCategory: 'creative', contentTypeKey: 'newsletter', confidence: 84, evidence };
    }
  }

  // FALLBACK LOGIC: Conservative heuristics based on structure and length
  
  // Academic fallbacks
  if (avgSentenceLength > 20 && /\b(theory|concept|framework|analysis|evidence|research|study)\b/i.test(lower)) {
    evidence.push('fallback:academicVocabulary', 'fallback:complexSentences');
    return { contentCategory: 'academic', contentTypeKey: 'essay', confidence: 65, evidence };
  }

  // Business fallback
  if (/\b(project|team|management|strategy|meeting|deadline|client|stakeholder)\b/i.test(lower)) {
    evidence.push('fallback:businessVocabulary');
    return { contentCategory: 'business', contentTypeKey: 'email-formal', confidence: 60, evidence };
  }

  // Technical fallback
  if (/\b(system|software|code|data|process|configure|install|execute)\b/i.test(lower)) {
    evidence.push('fallback:technicalVocabulary');
    return { contentCategory: 'technical', contentTypeKey: 'documentation', confidence: 60, evidence };
  }

  // Creative fallback for very short text
  if (words < 100) {
    evidence.push('fallback:shortLength');
    return { contentCategory: 'creative', contentTypeKey: 'social-media', confidence: 55, evidence };
  }

  // Ultimate fallback: academic essay (most general)
  evidence.push('fallback:defaultAcademic');
  return { contentCategory: 'academic', contentTypeKey: 'essay', confidence: 50, evidence };
}

// convenience alias (keeps backward compatibility)
function detectContentType(text, subject = null) {
  return detectContentTypeUsingTemplates(text, subject, contentTypeTemplates);
}

      
// Update the getAdvancedPrompt function to use override:

function getAdvancedPrompt(text, mode, intensity, wordCount, isHumanizing = false, subject = null, questionType = null, contentCategory = null, contentTypeKey = null, userSpecifiedType = null) {
    const intensityConfig = {
        '1': { temp: 1.75, topK: 140, topP: 0.97, name: 'NATURAL' },
        '2': { temp: 1.95, topK: 160, topP: 0.99, name: 'ENHANCED' },
        '3': { temp: 1.97, topK: 190, topP: 0.999, name: 'ULTRA-HUMAN' }
    };
    
    const config = intensityConfig[intensity];

    // Build content-type instruction injection
   // Build content-type instruction injection
let contentTypeInstructions = '';
let detectionInfo = '';

if (userSpecifiedType) {
    // User manually specified the type - let AI interpret it
    contentTypeInstructions = `
═══════════════════════════════════════════════════════════════════════════
🎯 USER-SPECIFIED TEXT TYPE: "${userSpecifiedType}"
═══════════════════════════════════════════════════════════════════════════

CRITICAL INSTRUCTION: The user has specified this text type. You MUST:

1. UNDERSTAND THE TYPE: Interpret "${userSpecifiedType}" even if misspelled (e.g., "acadmic esay" = academic essay, "reserch paper" = research paper, "blog pst" = blog post)

2. MATCH THE STRUCTURE: Follow the EXACT structure conventions for this text type:
   - If it's an essay: Introduction → Body Paragraphs (with topic sentences, evidence, analysis) → Conclusion
   - If it's a research paper: Abstract → Introduction → Methodology → Results → Discussion → Conclusion
   - If it's a news article: Inverted pyramid (most important first), quotes, attribution
   - If it's a blog post: Engaging hook, conversational but informative, actionable takeaways
   - If it's a business email: Subject line logic, professional greeting, clear purpose, call-to-action
   - Match whatever structure is standard for "${userSpecifiedType}"

3. USE APPROPRIATE VOCABULARY: 
   - Academic: Use scholarly language, field-specific terms, formal register
   - Journalism: Use clear, factual language, proper attribution (according to, sources say)
   - Business: Use professional terminology, action-oriented language
   - Creative: Use vivid, sensory language, show don't tell
   - Technical: Use precise technical terms, step-by-step clarity

4. FOLLOW GENRE CONVENTIONS:
   - Academic: Citations needed, thesis-driven, analytical depth, counterarguments
   - News: Lead with key facts, quotes from sources, objective tone, inverted pyramid
   - Blog: Conversational tone, subheadings, scannable, personality
   - Business: Professional, concise, results-focused, clear action items
   - Technical: Logical sequence, clarity over style, examples and screenshots

5. MAINTAIN HUMAN AUTHENTICITY: 
   - While following structure, keep natural sentence variation
   - Use the vocabulary of the genre but vary sentence length dramatically
   - Follow conventions but avoid AI-pattern words (no delve, robust, leverage, etc.)
   - Be structurally sound AND naturally human

YOU ARE WRITING A REAL ${userSpecifiedType.toUpperCase()} - NOT JUST "HUMAN-SOUNDING TEXT"
Follow the discipline. Follow the structure. Follow the conventions. But write like a human expert in this format would write.
`;
    detectionInfo = `\n🎯 USER-SPECIFIED TEXT TYPE: "${userSpecifiedType}"\n`;
} else if (contentCategory && contentTypeKey) {
    contentTypeInstructions = getStyleForContentType(contentCategory, contentTypeKey);
    detectionInfo = `\n🤖 AUTO-DETECTED TEXT TYPE: ${contentCategory}/${contentTypeKey}\n`;
}

    // subject inference
    let resolvedSubject = subject;
    if (!resolvedSubject && typeof inferSubjectFromText === 'function') {
      const inferred = inferSubjectFromText(text);
      if (inferred) resolvedSubject = inferred;
    }

    // build subject instruction block
    let subjectInstructions = '';
    if (typeof getSubjectSpecificInstructions === 'function') {
      if (resolvedSubject && questionType) subjectInstructions = getSubjectSpecificInstructions(resolvedSubject, questionType);
      else if (resolvedSubject) subjectInstructions = getSubjectSpecificInstructions(resolvedSubject, null);
      else if (questionType) subjectInstructions = `STRUCTURE (${questionTypes[questionType].short}): ${questionTypes[questionType].template.join(' | ')}`;
    }
    
    // --- original basePrompt left intact (only subjectInstructions is injected where you already reference getSubjectSpecificInstructions) ---
    const basePrompt = isHumanizing 
        ? `You are executing PROFESSIONAL-GRADE MILITARY-LEVEL TEXT HUMANIZATION. This is NOT casual rewriting. This is DEEP STRUCTURAL WARFARE against AI detection algorithms.

🎯 MISSION: Create 100% UNDETECTABLE human content | ${wordCount} words | ${config.name} MODE
${detectionInfo}

═══════════════════════════════════════════════════════════════════
⚠️ ABSOLUTE PRESERVATION PROTOCOL - NON-NEGOTIABLE
═══════════════════════════════════════════════════════════════════

PRESERVE 100% EXACTLY AS WRITTEN:
✅ ALL citations: (Smith, 2023), Johnson et al., [1], (Author, Year)
✅ ALL researcher names: Smith, Johnson, Lee, Garcia, etc.
✅ ALL dates and years: 2023, March 2024, 1990s, etc.
✅ ALL statistics: 67%, 2.3 million, p < 0.05, etc.
✅ ALL numerical data: measurements, percentages, figures
✅ ALL quotes: "exact quoted text" unchanged
✅ ALL technical terms: discipline-specific vocabulary
✅ ALL proper nouns: institutions, places, organizations
✅ ALL specific claims and factual content
✅ Document structure: keep bullets as bullets, paragraphs as paragraphs

TARGET WORD COUNT: ${countWords(text)} words (±1% tolerance = ${Math.floor(countWords(text) * 0.99)}-${Math.ceil(countWords(text) * 1.01)} words)



═══════════════════════════════════════════════════════════════════
💀 NUCLEAR AI PATTERN ANNIHILATION - ZERO SURVIVORS
═══════════════════════════════════════════════════════════════════

🚫 INSTANT DEATH LIST - ELIMINATE ON SIGHT:

FORBIDDEN VERBS (Replace immediately):
❌ delve/delving → examine, explore, investigate, analyze, scrutinize
❌ utilize → use, employ, apply, deploy
❌ leverage → use, exploit, harness, apply
❌ facilitate → enable, support, help, allow
❌ implement → apply, introduce, establish, execute
❌ demonstrate → show, reveal, prove, indicate
❌ showcase → display, present, exhibit, reveal
❌ underscore → emphasize, highlight, stress, show
❌ endeavor → attempt, try, seek, strive
❌ harness → use, exploit, employ, apply

FORBIDDEN ADJECTIVES (Replace immediately):
❌ robust → strong, powerful, solid, effective, substantial
❌ comprehensive → complete, thorough, extensive, full, detailed
❌ seamless → smooth, integrated, fluid, effortless, unified
❌ innovative → novel, new, original, creative, fresh
❌ cutting-edge → advanced, modern, latest, contemporary, new
❌ dynamic → active, changing, evolving, adaptive, fluid
❌ pivotal → crucial, critical, key, essential, vital
❌ paramount → essential, critical, vital, crucial, foremost

FORBIDDEN NOUNS (Replace immediately):
❌ landscape → field, area, domain, context, environment, sphere
❌ paradigm → model, framework, approach, system, perspective
❌ realm → field, area, domain, sphere, territory
❌ tapestry → collection, mixture, blend, combination, array
❌ ecosystem → system, network, environment, community, structure
❌ framework → structure, system, model, approach, scheme

FORBIDDEN TRANSITIONS (Replace immediately):
❌ Furthermore, Moreover, Additionally → Second, Also, Next, Besides, Research shows
❌ In addition, → Also, Second, Next, Beyond this
❌ It is important to note → Notably, Importantly, Crucially, Note that
❌ It should be emphasized → Emphasis falls on, Critical here is
❌ As mentioned earlier → Earlier, Previously, As shown
❌ In conclusion, To summarize → Finally, Ultimately, Overall, Thus
❌ Consequently, Therefore, Thus (at start) → This means, Data shows, Results indicate

FORBIDDEN SENTENCE STARTERS (NEVER use):
❌ "In today's world/society/era..."
❌ "In recent years/times..."
❌ "Throughout history..."
❌ "It is important/essential/crucial to..."
❌ "It is worth noting that..."
❌ "As we navigate..."
❌ "In the realm/landscape of..."
❌ "In light of..."
❌ "With regards to..."
❌ "When it comes to..."

FORBIDDEN CONSTRUCTIONS (Destroy completely):
❌ "not only X but also Y" → "X and Y" OR "X. Beyond this, Y" OR "X, with Y adding to this"
❌ "both X and Y" at sentence start → "X and Y" OR "X alongside Y"
❌ "either X or Y" → "X or Y" directly OR restructure completely
❌ Lists of exactly 3 items → Use 2, 4, 5, or 6 items NEVER 3
❌ Three adjectives in a row → Use 2, 4, or 5 NEVER 3
❌ Perfect parallel structure → Deliberately break symmetry

═══════════════════════════════════════════════════════════════════
⚡ EXTREME STRUCTURAL CHAOS ENGINEERING
═══════════════════════════════════════════════════════════════════

SENTENCE LENGTH DISTRIBUTION (enforce strictly):
Per 20 sentences, you MUST have:
- 4-7 words: 3 sentences (15%)
- 8-15 words: 6 sentences (30%)
- 16-25 words: 5 sentences (25%)
- 26-35 words: 3 sentences (15%)
- 36-45 words: 2 sentences (10%)
- 46+ words: 1 sentence (5%)

CRITICAL RULES:
✅ Never two consecutive sentences within 8 words of each other
✅ Standard deviation must exceed 12 words
✅ Mix short punchy sentences with long complex ones unpredictably
✅ At least 1 sentence under 6 words per 10 sentences
✅ At least 1 sentence over 40 words per 15 sentences

SENTENCE STRUCTURE ROTATION (cycle through ALL types):
1. Simple declarative: "Research confirms this pattern."
2. Compound with coordination: "Research confirms this, and evidence supports it."
3. Complex with subordination: "Research confirms this because data shows patterns."
4. Compound-complex: "Research confirms this, which matters, though critics disagree."
5. Embedded clause: "Research, despite skepticism, confirms this."
6. Appositive: "Research, a comprehensive study, confirms this."
7. Inverted: "Crucial to understanding is this research finding."
8. Passive construction: "This pattern was confirmed by multiple studies."
9. Participial phrase: "Examining the data closely, researchers found patterns."
10. Absolute phrase: "The data analyzed, researchers identified clear trends."
11. Conditional: "If these findings hold, implications prove substantial."
12. Interrogative: "What explains this persistent pattern?"
13. Fragment for emphasis: "A critical distinction."
14. Front-loaded subordinate: "Although critics questioned methods, findings held."
15. Back-loaded subordinate: "Findings held strong, although critics questioned methods."

DEPLOY 12+ DIFFERENT TYPES PER 20 SENTENCES. NEVER REPEAT PATTERNS.

═══════════════════════════════════════════════════════════════════
🎭 ADVANCED PERPLEXITY & BURSTINESS ENGINEERING
═══════════════════════════════════════════════════════════════════

VOCABULARY SOPHISTICATION (45% lexical substitution rate):

Replace common words with sophisticated variants (rotate, don't repeat):

"shows" → reveals, indicates, demonstrates, evinces, manifests, signals, suggests, reflects, betrays, bespeaks

"important" → significant, crucial, vital, critical, essential, pivotal, consequential, substantial, material, salient

"because" → since, as, given that, owing to, stemming from, in that, by virtue of, on account of

"different" → distinct, disparate, divergent, diverse, varied, discrete, heterogeneous, dissimilar, contrasting

"increase" → rise, grow, expand, escalate, augment, amplify, intensify, swell, mount, burgeon

"decrease" → decline, fall, diminish, reduce, contract, wane, ebb, subside, dwindle, recede

"use" → employ, apply, utilize (sparingly), deploy, implement, harness, exploit, wield

"make" → create, produce, generate, craft, forge, construct, form, fashion, constitute

"understand" → comprehend, grasp, perceive, discern, apprehend, fathom, recognize, appreciate

"problem" → issue, challenge, difficulty, obstacle, complication, predicament, dilemma, hurdle

"solution" → answer, resolution, remedy, fix, approach, response, measure, recourse

"change" → shift, alter, transform, modify, adjust, revise, convert, evolve, transition

"analyze" → examine, scrutinize, investigate, probe, assess, evaluate, dissect, inspect, parse

"study" → research, investigation, examination, inquiry, analysis, exploration, review, survey

MIX SOPHISTICATION LEVELS NATURALLY:
- 35% high register (Latinate, technical)
- 50% mid register (standard academic)
- 15% accessible register (clear, direct)

NEVER maintain same register for 4+ consecutive sentences.

═══════════════════════════════════════════════════════════════════
🔄 TRANSITION OBLITERATION PROTOCOL
═══════════════════════════════════════════════════════════════════

TRANSITION STRATEGY:
- 70% of transitions: ZERO explicit connector (continue naturally)
- 20% of transitions: Embedded mid-sentence (e.g., "Data, however, shows...")
- 10% of transitions: Minimal at start (e.g., "Yet findings suggest...")

NATURAL CONTINUATION EXAMPLES:
❌ "Furthermore, research indicates..." 
✅ "Research indicates..." (just continue)

❌ "Moreover, data shows..."
✅ "Data shows..." (no transition needed)

❌ "In addition, studies reveal..."
✅ "Studies reveal..." (continue naturally)

PERMITTED TRANSITIONS (use sparingly - MAX 10% of sentences):
✅ "Yet findings suggest..." (adversative)
✅ "Data, however, reveals..." (embedded contrast)
✅ "Still, evidence indicates..." (concessive)
✅ "Second," "Third," (enumeration - rare)
✅ "This suggests..." (demonstrative linkage)

═══════════════════════════════════════════════════════════════════
🎲 HUMAN AUTHENTICITY ENGINEERING
═══════════════════════════════════════════════════════════════════

CONFIDENCE MODULATION (vary within paragraphs):
- 20% absolute certainty: "This proves..." "Data establishes..." "X causes Y."
- 30% strong confidence: "This strongly suggests..." "Evidence clearly indicates..."
- 30% moderate: "This suggests..." "Data implies..." "This indicates..."
- 20% hedged: "This tends to suggest..." "Data appears to indicate..." "This may show..."

NEVER maintain same confidence level for 4+ consecutive claims.

STRATEGIC IMPERFECTION (2-4 instances per 1000 words):
✅ Conversational academic: "This makes sense when considering..."
✅ Natural qualification: "To be sure, alternatives exist."
✅ Thinking-on-page: "Initially X appears true. Deeper analysis reveals Y."
✅ Mild informality (within bounds): "Here's what data reveals."
✅ Direct address: "Consider the implications."
✅ Self-refinement: "This suggests correlation. More precisely, it indicates causation."

RECURSIVE ARGUMENTATION (3-5 instances per 1500 words):
✅ "Returning to the initial observation, findings add dimension."
✅ "Recall the earlier discussion. Current data reframes this."
✅ "This appears to contradict prior claims. Yet contradiction proves superficial."
✅ "Connecting this to the initial premise clarifies the argument."

RHETORICAL SOPHISTICATION (2-3 instances per 1000 words):
✅ Strategic questions: "What explains this pattern?"
✅ Subtle metaphor: "Data functions as a lens revealing patterns."
✅ Anticipatory objection: "Critics might argue X. Yet evidence shows Y."
✅ Emphatic restatement: "This matters. It matters because..."
✅ Conditional speculation: "Were findings to replicate, revision becomes necessary."

═══════════════════════════════════════════════════════════════════
📊 CITATION INTEGRATION CHAOS
═══════════════════════════════════════════════════════════════════

ROTATE CITATION STYLES (cycle through 10+ types):
1. Parenthetical end: "Pattern emerges consistently (Smith, 2020)."
2. Narrative start: "Smith (2020) found patterns emerging."
3. Embedded middle: "Pattern, as Smith (2020) notes, emerges."
4. Possessive: "Smith's (2020) research reveals patterns."
5. According to: "According to Smith (2020), patterns emerge."
6. Verb-integrated: "Smith (2020) demonstrates pattern consistency."
7. Multiple: "Research confirms this (Smith, 2020; Jones, 2019; Lee, 2021)."
8. Descriptive: "In Smith's (2020) study, patterns emerged."
9. Parenthetical mid-sentence: "Pattern emerges, Smith (2020) argues, consistently."
10. Concessionary: "While Smith (2020) focuses on X, analysis reveals Y."

NEVER use same citation style twice consecutively.

VARY CITATION DENSITY:
- Some paragraphs: 0 citations (analysis/synthesis)
- Some paragraphs: 1-2 citations (selective support)
- Some paragraphs: 4-6 citations (literature-heavy)

═══════════════════════════════════════════════════════════════════
📐 PARAGRAPH ARCHITECTURE CHAOS
═══════════════════════════════════════════════════════════════════

PARAGRAPH LENGTH (per 10 paragraphs):
- 1-2 sentences: 1 paragraph (powerful emphasis)
- 3-4 sentences: 3 paragraphs
- 5-6 sentences: 3 paragraphs
- 7-8 sentences: 2 paragraphs
- 9+ sentences: 1 paragraph (sustained development)

PARAGRAPH OPENING ROTATION (cycle through 12+ types):
1. Declarative: "Research establishes correlation."
2. Interrogative: "What explains this pattern?"
3. Data-first: "67% of participants showed improvement."
4. Citation-led: "Smith (2020) demonstrates shifts."
5. Qualification: "Granted, alternatives merit consideration."
6. Example: "Consider longitudinal studies."
7. Demonstrative: "This pattern emerges consistently."
8. Transitional (rare): "Yet findings reveal complexity."
9. Comparative: "Unlike previous studies, this reveals..."
10. Causal: "Because frameworks fail to account for X..."
11. Conditional: "If findings hold, implications prove substantial."
12. Fragment (occasional): "A critical distinction."

NEVER use same opening type twice consecutively.

═══════════════════════════════════════════════════════════════════
✅ WORD COUNT PRECISION MANDATE
═══════════════════════════════════════════════════════════════════

ORIGINAL TEXT WORD COUNT: ${countWords(text)} words
TARGET OUTPUT: ${Math.floor(countWords(text) * 0.99)}-${Math.ceil(countWords(text) * 1.01)} words (±1%)

ACHIEVE THIS THROUGH:
✅ One-to-one vocabulary swaps: "utilize" → "use"
✅ Sentence restructuring with word conservation
✅ Compression of wordy phrases: "due to the fact that" → "because"
✅ Expansion of terse phrases where needed: "big" → "substantial"

VERIFY BEFORE OUTPUT: Count must be within ±1% of original.

═══════════════════════════════════════════════════════════════════
🎯 FINAL EXECUTION CHECKLIST
═══════════════════════════════════════════════════════════════════

Before outputting, verify:
☑ ZERO AI vocabulary (no delve, robust, leverage, comprehensive, etc.)
☑ ZERO forbidden transitions (no furthermore, moreover, additionally at start)
☑ ZERO forbidden constructions (no "not only...but also", no perfect parallels)
☑ Sentence length varies dramatically (SD > 12 words)
☑ 12+ sentence structure types deployed
☑ 10+ citation styles used (if applicable)
☑ 12+ paragraph opening types used
☑ Confidence levels mixed within paragraphs
☑ Register mixing (high/mid/accessible) within paragraphs
☑ Strategic imperfections present (2-4 per 1000 words)
☑ Recursive callbacks deployed (3-5 per 1500 words)
☑ Word count within ±1% of original
☑ ALL citations, names, dates, data preserved EXACTLY
☑ Natural human rhythm and flow throughout
☑ Academic rigor and sophistication maintained

═══════════════════════════════════════════════════════════════════
🚀 HUMANIZATION EXECUTION
═══════════════════════════════════════════════════════════════════

SUBJECT INSTRUCTIONS:
${subjectInstructions}

CONTENT-TYPE INSTRUCTIONS:
${contentTypeInstructions}

      
TEXT TO HUMANIZE:
${text}

EXECUTE FULL PROTOCOL NOW.
OUTPUT ONLY THE HUMANIZED TEXT.
NO explanations. NO commentary. NO notes.
PURE 100% UNDETECTABLE HUMAN WRITING.
`
        : `You are executing PROFESSIONAL-GRADE MILITARY-LEVEL CONTENT GENERATION. This is NOT AI-generated text. This is AUTHENTIC HUMAN SCHOLARLY WRITING from first principles.

🎯 MISSION: Create 100% UNDETECTABLE human content | ${wordCount} words | ${config.name} MODE

═══════════════════════════════════════════════════════════════════
💀 NUCLEAR AI PATTERN ANNIHILATION - ZERO TOLERANCE
═══════════════════════════════════════════════════════════════════

🚫 FORBIDDEN VOCABULARY - INSTANT ELIMINATION:

NEVER USE THESE VERBS:
❌ delve, delving, utilize, leverage, facilitate, implement, showcase
❌ underscore, endeavor, harness, demonstrate (overused)

REPLACE WITH:
✅ examine, explore, investigate, use, employ, apply, enable, support
✅ show, reveal, prove, indicate, attempt, try, seek

NEVER USE THESE ADJECTIVES:
❌ robust, comprehensive, seamless, innovative, cutting-edge, dynamic
❌ pivotal, paramount

REPLACE WITH:
✅ strong, effective, complete, thorough, smooth, new, original
✅ crucial, critical, essential, vital

NEVER USE THESE NOUNS:
❌ landscape, paradigm, realm, tapestry, ecosystem

REPLACE WITH:
✅ field, area, domain, context, model, framework, system, network

NEVER START SENTENCES WITH:
❌ Furthermore, Moreover, Additionally, In addition,
❌ It is important/essential/crucial to note that...
❌ It is worth noting that...
❌ In today's world/society/era...
❌ In recent years...
❌ Throughout history...

═══════════════════════════════════════════════════════════════════
⚡ EXTREME STRUCTURAL VARIATION MANDATE
═══════════════════════════════════════════════════════════════════

SENTENCE LENGTH DISTRIBUTION (enforce per 20 sentences):
- 4-7 words: 3 sentences (15%) - punchy, direct
- 8-15 words: 6 sentences (30%) - clear, focused
- 16-25 words: 5 sentences (25%) - standard academic
- 26-35 words: 3 sentences (15%) - complex development
- 36-45 words: 2 sentences (10%) - sophisticated layering
- 46+ words: 1 sentence (5%) - sustained complexity

CRITICAL: Standard deviation MUST exceed 12 words.
NEVER write two consecutive sentences within 8 words of each other.

SENTENCE STRUCTURE VARIETY (rotate through 15+ types):
1. Simple: "Research confirms patterns." [3 words]
2. Compound: "Research confirms patterns, and data supports findings." [8 words]
3. Complex: "Research confirms patterns because data shows consistency." [8 words]
4. Compound-complex: "Research confirms patterns, which matters, though critics disagree." [9 words]
5. Embedded clause: "Research, despite skepticism, confirms patterns." [6 words]
6. Appositive: "Research, a comprehensive study, confirms patterns." [7 words]
7. Inverted: "Critical to understanding is this research finding." [7 words]
8. Passive (30% max): "Patterns were confirmed by research." [6 words]
9. Participial: "Examining data closely, researchers found patterns." [6 words]
10. Absolute phrase: "Data analyzed, researchers identified trends." [6 words]
11. Conditional: "If findings hold, implications prove substantial." [7 words]
12. Interrogative: "What explains this persistent pattern?" [5 words]
13. Fragment (rare): "A critical distinction." [3 words]
14. Front subordinate: "Although critics questioned methods, findings held." [7 words]
15. Back subordinate: "Findings held, although critics questioned methods." [7 words]

USE 12+ TYPES PER 20 SENTENCES. NEVER PREDICTABLE PATTERNS.

═══════════════════════════════════════════════════════════════════
🎭 SOPHISTICATED VOCABULARY ENGINEERING
═══════════════════════════════════════════════════════════════════

VOCABULARY SOPHISTICATION (rotate naturally, don't repeat):

POWER VERBS (use varied):
reveals, indicates, demonstrates, shows, suggests, implies, evinces
manifests, reflects, proves, establishes, confirms, signals, betrays
examines, explores, investigates, analyzes, scrutinizes, probes
creates, produces, generates, develops, constructs, forms, builds

PRECISION NOUNS (use varied):
research, study, analysis, investigation, examination, inquiry
evidence, data, findings, results, observations, outcomes
pattern, trend, phenomenon, process, mechanism, dynamic
factor, element, aspect, component, dimension, feature

SOPHISTICATED DESCRIPTORS (use varied):
significant, substantial, considerable, notable, marked, pronounced
critical, crucial, essential, vital, pivotal, key, central
complex, intricate, sophisticated, nuanced, multifaceted
clear, evident, apparent, obvious, manifest, distinct

REGISTER MIXING (within paragraphs):
- 35% high register: Latinate, technical, sophisticated
- 50% mid register: Standard academic, professional
- 15% accessible: Clear, direct, straightforward

NEVER maintain same register for 4+ consecutive sentences.

═══════════════════════════════════════════════════════════════════
🔄 NATURAL FLOW WITHOUT MECHANICAL TRANSITIONS
═══════════════════════════════════════════════════════════════════

TRANSITION STRATEGY:
- 70%: ZERO explicit transition (continue naturally)
- 20%: Embedded mid-sentence ("Data, however, reveals...")
- 10%: Minimal at start ("Yet findings suggest...")

NATURAL CONTINUATION (no transition needed):
"Research establishes patterns. Data supports these findings."
"Studies show clear trends. Evidence confirms consistency."
"Analysis reveals complexity. Examination exposes nuances."

EMBEDDED TRANSITIONS (mid-sentence):
"Data, however, suggests otherwise."
"Findings, despite initial skepticism, prove robust."
"Research, while preliminary, indicates patterns."

MINIMAL STARTERS (use sparingly):
"Yet findings reveal..."
"Still, evidence suggests..."
"Second, analysis shows..."

═══════════════════════════════════════════════════════════════════
🎲 HUMAN AUTHENTICITY MARKERS
═══════════════════════════════════════════════════════════════════

CONFIDENCE VARIATION (mix within paragraphs):
- Absolute (20%): "This proves..." "Data establishes..." "X causes Y."
- Strong (30%): "This strongly suggests..." "Evidence clearly indicates..."
- Moderate (30%): "This suggests..." "Data indicates..." "This shows..."
- Hedged (20%): "This tends to suggest..." "Data appears to show..."

STRATEGIC IMPERFECTION (2-4 per 1000 words):
✅ "This makes sense when considering context."
✅ "The question naturally arises: what explains this?"
✅ "To be sure, alternative explanations exist."
✅ "Initially X appears true. Deeper analysis reveals Y."
✅ "Consider the theoretical implications."
✅ "Here's what data reveals."

RECURSIVE DEVELOPMENT (3-5 per 1500 words):
✅ "Returning to the initial point..."
✅ "This connects to earlier observations..."
✅ "Recall the previous discussion..."
✅ "This reframes the original question..."

RHETORICAL SOPHISTICATION (2-3 per 1000 words):
✅ Strategic questions: "What drives this pattern?"
✅ Anticipatory objection: "Critics might argue X. Yet data shows Y."
✅ Emphatic restatement: "This matters. It matters because..."
✅ Conditional: "Were findings to replicate, implications prove substantial."

═══════════════════════════════════════════════════════════════════
📐 PARAGRAPH ARCHITECTURE VARIATION
═══════════════════════════════════════════════════════════════════

PARAGRAPH LENGTH (per 10 paragraphs):
- 1-2 sentences: 1 paragraph (emphasis)
- 3-4 sentences: 3 paragraphs (focused points)
- 5-6 sentences: 3 paragraphs (standard development)
- 7-8 sentences: 2 paragraphs (complex ideas)
- 9+ sentences: 1 paragraph (sustained argument)

PARAGRAPH OPENING VARIETY (rotate through 12+ types):
1. Direct claim: "Research establishes clear patterns."
2. Question: "What explains this phenomenon?"
3. Data-first: "67% of studies show consistency."
4. Qualification: "Granted, alternative views exist."
5. Example: "Consider longitudinal research."
6. Demonstrative: "This pattern emerges repeatedly."
7. Comparative: "Unlike previous studies..."
8. Causal: "Because frameworks fail to explain..."
9. Conditional: "If these findings hold..."
10. Fragment (rare): "A critical distinction."
11. Temporal: "Over the past decade..."
12. Counter: "Critics argue otherwise. Yet..."

NEVER use same type twice consecutively.

═══════════════════════════════════════════════════════════════════
✅ EXECUTION CHECKLIST
═══════════════════════════════════════════════════════════════════

Before outputting, verify:
☑ ZERO AI vocabulary (no delve, robust, leverage, comprehensive)
☑ ZERO forbidden transitions (no furthermore, moreover at start)
☑ Sentence length varies dramatically (SD > 12 words)
☑ 12+ sentence structures used
☑ 12+ paragraph openings used
☑ Confidence levels mixed
☑ Register mixing within paragraphs
☑ Strategic imperfections present
☑ Natural flow without mechanical transitions
☑ Academic sophistication maintained
☑ Word count: ${wordCount} words (±2% = ${Math.floor(wordCount * 0.98)}-${Math.ceil(wordCount * 1.02)} words)

═══════════════════════════════════════════════════════════════════
🚀 CONTENT GENERATION EXECUTION
═══════════════════════════════════════════════════════════════════

SUBJECT INSTRUCTIONS:
${subjectInstructions}

CONTENT-TYPE INSTRUCTIONS:
${contentTypeInstructions}

TOPIC/BRIEF:
${text}

TARGET: ${wordCount} words of sophisticated, direct, advanced human scholarly writing.

GENERATE NOW.
OUTPUT ONLY THE CONTENT.
NO explanations. NO commentary. NO notes.
PURE 100% UNDETECTABLE HUMAN WRITING.
`;

    return { prompt: basePrompt, config };
}

// =====================================================

async function enhanceContent(originalText, userInstructions, apiKey, subject) {
    const wordCount = countWords(originalText);
    
    const enhancementPrompt = `You are an EXPERT ACADEMIC CONTENT ENHANCER. Your mission: ADD missing information to complete this content for FULL MARKS while maintaining 100% HUMAN WRITING.

═══════════════════════════════════════════════════════════════════
🎯 CONTENT ENHANCEMENT MISSION
═══════════════════════════════════════════════════════════════════

ORIGINAL CONTENT WORD COUNT: ${wordCount} words

USER INSTRUCTIONS - WHAT TO ADD/ENHANCE:
${userInstructions}

SUBJECT CONTEXT: ${subject}

═══════════════════════════════════════════════════════════════════
📋 ENHANCEMENT PROTOCOL
═══════════════════════════════════════════════════════════════════

YOUR TASK:
1. READ the original content carefully
2. IDENTIFY what's missing based on user instructions
3. ADD missing information seamlessly
4. MAINTAIN the original style and voice
5. ENSURE new content is 100% HUMAN WRITING
6. INTEGRATE additions naturally (no obvious seams)

WHAT YOU MIGHT ADD:
✅ Missing evidence or examples
✅ Deeper analysis or explanation
✅ Additional paragraphs for underdeveloped sections
✅ Stronger introduction or conclusion
✅ Counterarguments and rebuttals
✅ More sophisticated vocabulary where appropriate
✅ Better transitions between ideas
✅ Specific data or research findings
✅ Theoretical frameworks or context
✅ Critical evaluation or assessment

INTEGRATION REQUIREMENTS:
- Additions must flow naturally from existing content
- Match the tone, style, and register of original
- No sudden shifts in voice or sophistication
- Citations/references integrated properly if adding evidence
- Maintain argument coherence throughout
- Enhanced sections should feel like they were always there

FULL MARKS CRITERIA:
✅ Complete coverage of topic (no gaps)
✅ Sufficient depth of analysis
✅ Strong evidence and examples
✅ Clear, logical structure
✅ Sophisticated academic writing
✅ Critical thinking demonstrated
✅ Proper introduction and conclusion
✅ Smooth transitions throughout
✅ Appropriate length for assignment type

═══════════════════════════════════════════════════════════════════
💀 MAINTAIN ANTI-AI DETECTION PROTOCOL
═══════════════════════════════════════════════════════════════════

FORBIDDEN VOCABULARY (even in additions):
❌ delve, robust, leverage, comprehensive, facilitate
❌ landscape, paradigm, realm, tapestry
❌ Furthermore, Moreover, Additionally (at sentence start)

REQUIRED VARIATION (in additions):
✅ Varied sentence lengths (8-45 words)
✅ Multiple sentence structures
✅ Mixed confidence levels
✅ Natural transitions
✅ Sophisticated but accessible vocabulary
✅ Human imperfections and authenticity

═══════════════════════════════════════════════════════════════════
📄 ORIGINAL CONTENT TO ENHANCE
═══════════════════════════════════════════════════════════════════

${originalText}

═══════════════════════════════════════════════════════════════════
🚀 EXECUTION INSTRUCTIONS
═══════════════════════════════════════════════════════════════════

OUTPUT FORMAT:
1. First, output: "=== ENHANCED CONTENT ==="
2. Then output the COMPLETE enhanced version
3. Mark additions with [ADDED] at the start and [/ADDED] at the end
4. This allows user to see what was added

EXAMPLE OUTPUT FORMAT:
[Original paragraph 1...]

[ADDED]
New paragraph with additional analysis and examples that address the gap identified. This integrates naturally with the existing content, maintaining voice and style while adding depth.
[/ADDED]

[Original paragraph 2...]

REQUIREMENTS:
- Output COMPLETE enhanced content (original + additions)
- Mark all additions with [ADDED]...[/ADDED] tags
- Ensure additions are seamless and natural
- Maintain 100% human writing throughout
- Follow all anti-AI detection protocols
- Achieve full marks quality

ENHANCE NOW. OUTPUT THE COMPLETE ENHANCED CONTENT.`;

    const config = {
        temp: 1.85,
        topK: 140,
        topP: 0.985
    };

    return await callGeminiAPI(enhancementPrompt, config, apiKey);
}
      
      // =====================================================
// SUBJECT-SPECIFIC ULTRA-AGGRESSIVE PROMPTS
// =====================================================

function getSubjectSpecificInstructions(subject, questionType) {
    const instructions = {
        // BIOLOGY INSTRUCTIONS
        biology: {
            analyze: `
═══════════════════════════════════════════════════════════════════
🧬 BIOLOGY ANALYSIS - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

BIOLOGICAL ANALYSIS REQUIREMENTS:

VOCABULARY PRECISION:
✅ Use: organism, cellular, molecular, genetic, physiological, metabolic
✅ Use: enzymatic, ecological, evolutionary, systematic, taxonomic
✅ Use: homeostatic, morphological, anatomical, biochemical
✅ Processes: respiration, photosynthesis, transcription, translation, replication
✅ Mechanisms: feedback loops, signal transduction, gene expression, protein synthesis

ANALYTICAL APPROACH:
- Structure-function relationships: Always connect form to function
- Multiple levels: molecular → cellular → tissue → organ → organism → ecosystem
- Mechanisms not just descriptions: Explain HOW and WHY, not just WHAT
- Evidence-based: Reference experimental data, observations, studies
- Evolutionary context: Consider selective advantages where relevant

SENTENCE CONSTRUCTION:
❌ "The mitochondria is the powerhouse of the cell" (cliché, oversimplified)
✅ "Mitochondria generate ATP through oxidative phosphorylation, coupling electron transport to chemiosmotic gradient formation across the inner membrane."

❌ "Enzymes are important for reactions"
✅ "Enzymes lower activation energy by stabilizing transition states, accelerating reaction rates without altering equilibrium positions."

ANALYTICAL PATTERNS:
1. Observation → Mechanism → Significance
2. Structure → Function → Evolutionary advantage
3. Normal process → Disruption → Consequences
4. Molecular basis → Cellular effect → Organismal impact

SPECIFIC BIOLOGY MARKERS:
- Use Linnaean classification correctly (Kingdom, Phylum, Class, Order, Family, Genus, Species)
- Reference specific pathways (glycolysis, Krebs cycle, Calvin cycle, etc.)
- Mention specific molecules (ATP, NAD+, NADH, glucose-6-phosphate, etc.)
- Discuss regulatory mechanisms (negative feedback, allosteric regulation, etc.)
- Consider multiple scales of organization

AVOID GENERIC STATEMENTS:
❌ "The cell does many things"
❌ "This process is very important"
❌ "Biology studies life"
✅ Be specific, mechanistic, and evidence-based

HUMAN AUTHENTICITY:
- Mix simple declarative sentences with complex mechanistic explanations
- Use analogies sparingly and appropriately: "Like a lock-and-key mechanism..."
- Show understanding through connections: "This relates to earlier discussion of..."
- Natural hedging: "Evidence suggests..." "Data indicates..." "This appears to..."
`,

            explain: `
═══════════════════════════════════════════════════════════════════
🧬 BIOLOGY EXPLANATION - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

EXPLANATORY BIOLOGY WRITING:

EXPLANATION STRUCTURE:
1. Clear statement of what you're explaining
2. Break down into components/steps
3. Explain mechanism at appropriate level
4. Connect to broader context
5. Address common misconceptions if relevant

BIOLOGICAL EXPLANATION LANGUAGE:
✅ "Photosynthesis occurs in two stages: light-dependent reactions and the Calvin cycle."
✅ "During light-dependent reactions, photons excite electrons in chlorophyll molecules."
✅ "These excited electrons pass through electron transport chains, generating ATP and NADPH."
✅ "The Calvin cycle then uses these energy carriers to fix CO2 into organic molecules."

MECHANISTIC CLARITY:
- Explain processes step-by-step
- Use cause-effect relationships clearly
- Connect molecular events to observable outcomes
- Explain regulation and control mechanisms

PROCESS EXPLANATION PATTERN:
"X initiates when Y binds to Z. This binding triggers conformational changes in..."
"The process begins with... Subsequently... Finally..."
"First, substrate enters the active site. Second, enzyme-substrate complex forms. Third..."

AVOID:
❌ Circular reasoning: "It happens because it happens"
❌ Teleological language: "The cell wants to..." (cells don't "want")
❌ Oversimplification that loses accuracy

USE:
✅ Accurate mechanisms: "Selection pressure favors..." not "The organism adapted in order to..."
✅ Precise language: "DNA replication is semiconservative" not "DNA copies itself"
`,

            describe: `
═══════════════════════════════════════════════════════════════════
🧬 BIOLOGY DESCRIPTION - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

DESCRIPTIVE BIOLOGY WRITING:

DESCRIPTION APPROACH:
- Hierarchical organization: Start broad, move to specific OR vice versa
- Systematic coverage: Don't miss major components
- Precise terminology: Use correct biological terms
- Quantitative where possible: Include sizes, numbers, percentages

STRUCTURAL DESCRIPTION:
"The mitochondrion consists of four main regions: outer membrane, intermembrane space, inner membrane, and matrix. The inner membrane folds into cristae, increasing surface area for oxidative phosphorylation. Embedded within this membrane, electron transport chain complexes facilitate ATP synthesis."

ORGANISM DESCRIPTION:
- Taxonomic classification
- Morphological characteristics
- Anatomical features
- Physiological adaptations
- Ecological role/niche
- Behavioral patterns (if relevant)

PROCESS DESCRIPTION:
- Initial state
- Sequential steps/stages
- Intermediate states
- Final outcome
- Regulatory checkpoints

CELLULAR/MOLECULAR DESCRIPTION:
- Location (subcellular, tissue, organ)
- Size and shape
- Composition (molecular components)
- Structure-function relationships
- Interactions with other components

DESCRIPTIVE PRECISION:
❌ "The heart is a big muscle"
✅ "The heart, a four-chambered muscular organ weighing approximately 300 grams, pumps 5 liters of blood per minute at rest."

❌ "Cells have a nucleus"
✅ "The nucleus, typically 10-20 micrometers in diameter, contains chromatin enclosed by a double-membrane nuclear envelope perforated by nuclear pores."
`
        },

        // CHEMISTRY INSTRUCTIONS
        chemistry: {
            analyze: `
═══════════════════════════════════════════════════════════════════
⚗️ CHEMISTRY ANALYSIS - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

CHEMICAL ANALYSIS REQUIREMENTS:

VOCABULARY PRECISION:
✅ Use: molecular, atomic, ionic, covalent, electronegativity, stoichiometry
✅ Use: equilibrium, kinetics, thermodynamics, enthalpy, entropy, Gibbs free energy
✅ Use: oxidation, reduction, acid-base, buffer, catalyst, intermediate
✅ Reactions: substitution, elimination, addition, redox, precipitation, complexation
✅ Properties: polarity, solubility, reactivity, stability, bonding, hybridization

ANALYTICAL APPROACH:
- Molecular level understanding: Explain bonding, electron distribution, orbital interactions
- Energetic considerations: Discuss activation energy, reaction coordinate, energy barriers
- Mechanistic thinking: Show electron movement, intermediate formation, rate-determining steps
- Quantitative analysis: Use equations, calculations, equilibrium constants where relevant
- Periodic trends: Consider electronegativity, atomic radius, ionization energy patterns

SENTENCE CONSTRUCTION:
❌ "The reaction happens fast" (vague, unscientific)
✅ "The reaction proceeds rapidly due to low activation energy, proceeding through a single-step SN2 mechanism with inversion of configuration."

❌ "Acids are strong"
✅ "Strong acids completely dissociate in aqueous solution, yielding hydronium ions with Ka values exceeding 10^3."

ANALYTICAL PATTERNS:
1. Observation → Molecular explanation → Predictive application
2. Structure → Bonding → Properties → Reactivity
3. Thermodynamic feasibility → Kinetic accessibility → Reaction pathway
4. Reactants → Mechanism → Products → Side reactions

SPECIFIC CHEMISTRY MARKERS:
- Use IUPAC nomenclature correctly
- Reference specific reaction mechanisms (SN1, SN2, E1, E2, etc.)
- Mention orbital theory (sp3, sp2, sp hybridization, molecular orbitals)
- Discuss thermodynamic parameters (ΔH, ΔS, ΔG)
- Include equilibrium expressions and rate laws where relevant
- Reference periodic table trends explicitly

CHEMICAL REASONING:
"The nucleophile attacks the electrophilic carbon, forming a tetrahedral intermediate. Subsequent elimination of the leaving group regenerates the carbonyl, completing the substitution."

"Increasing temperature shifts the endothermic equilibrium rightward according to Le Chatelier's principle, favoring product formation despite the positive ΔH."

AVOID GENERIC STATEMENTS:
❌ "Chemistry is about mixing things"
❌ "This element is reactive"
❌ "The bond is strong"
✅ Be mechanistic, quantitative, and electron-focused

HUMAN AUTHENTICITY:
- Mix mechanistic explanations with observational statements
- Reference lab experience naturally: "When performing this reaction..."
- Show reasoning process: "One might expect X, yet data shows Y because..."
- Natural hedging: "The mechanism likely proceeds through..." "Data suggests..."
`,

            explain: `
═══════════════════════════════════════════════════════════════════
⚗️ CHEMISTRY EXPLANATION - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

EXPLANATORY CHEMISTRY WRITING:

EXPLANATION STRUCTURE:
1. Define/state what you're explaining
2. Provide molecular/atomic basis
3. Explain mechanism or process step-by-step
4. Connect to observable phenomena
5. Address common misconceptions

CHEMICAL EXPLANATION LANGUAGE:
✅ "Acids donate protons to bases, forming conjugate acid-base pairs."
✅ "In aqueous solution, HCl dissociates completely: HCl → H+ + Cl-"
✅ "The resulting hydronium ions (H3O+) lower pH below 7."
✅ "This complete dissociation distinguishes strong acids from weak acids, which partially dissociate."

MECHANISTIC CLARITY:
- Show electron movement with arrows (in writing: "electrons move from... to...")
- Explain bond breaking and forming explicitly
- Discuss intermediate species and transition states
- Explain rate-determining steps
- Address regio/stereochemistry where relevant

PROCESS EXPLANATION PATTERN:
"Electrophilic addition begins when the alkene's π electrons attack the electrophile, forming a carbocation intermediate. Subsequently, the nucleophile attacks this carbocation, yielding the addition product."

"The reaction proceeds via a two-step mechanism. First, the leaving group departs, generating a planar carbocation. Second, nucleophilic attack occurs from either face, producing racemic product."

THERMODYNAMIC/KINETIC EXPLANATION:
"While the reaction is thermodynamically favorable (ΔG < 0), it proceeds slowly due to high activation energy. Adding catalyst lowers this barrier without affecting equilibrium position."

AVOID:
❌ "The atoms just bond together"
❌ "Heat makes reactions faster" (incomplete)
❌ "It happens because of chemistry" (circular)

USE:
✅ "Covalent bonds form when atoms share electron pairs, lowering system energy."
✅ "Elevated temperature increases molecular kinetic energy, leading to more frequent collisions exceeding activation energy."
`,

            describe: `
═══════════════════════════════════════════════════════════════════
⚗️ CHEMISTRY DESCRIPTION - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

DESCRIPTIVE CHEMISTRY WRITING:

DESCRIPTION APPROACH:
- Systematic organization: By property type, reaction class, or structural feature
- Quantitative precision: Include numbers, measurements, values
- Comparative context: Relate to similar compounds/reactions
- Observable properties linked to molecular structure

COMPOUND DESCRIPTION:
"Ethanol (C2H5OH), a colorless liquid with molecular weight 46.07 g/mol, exhibits a boiling point of 78.4°C. The molecule contains a polar hydroxyl group, conferring water solubility and hydrogen bonding capability. Its amphiphilic nature—combining a hydrophobic ethyl group with a hydrophilic hydroxyl—enables miscibility with both polar and nonpolar solvents."

REACTION DESCRIPTION:
- Reactants (with structures/formulas)
- Reaction conditions (temperature, pressure, catalyst, solvent)
- Reaction type/mechanism
- Products (with yields if known)
- Side reactions or byproducts
- Observable changes (color, temperature, precipitation, etc.)

PROPERTY DESCRIPTION:
- Physical properties: MP, BP, density, solubility, color, odor
- Chemical properties: acidity/basicity, reactivity, stability, flammability
- Structural features: bonding, geometry, hybridization, functional groups
- Electronic properties: polarity, dipole moment, electron distribution

STRUCTURAL DESCRIPTION:
"The molecule adopts tetrahedral geometry around the central carbon, with sp3 hybridization. Bond angles approximate 109.5°, though slight distortion occurs due to lone pair repulsion from the oxygen atom."

DESCRIPTIVE PRECISION:
❌ "Water is a common liquid"
✅ "Water (H2O), with molecular weight 18.02 g/mol, exhibits anomalously high boiling point (100°C) due to extensive hydrogen bonding networks. Its bent molecular geometry (104.5° bond angle) creates a polar molecule with dipole moment 1.85 D."

❌ "The solution turned red"
✅ "Upon adding phenolphthalein indicator, the solution transitioned from colorless to pink, indicating pH exceeding 8.2 as the equilibrium shifts toward the deprotonated quinoid form."

PERIODIC TABLE DESCRIPTIONS:
"Chlorine (Cl, atomic number 17) resides in Group 17 (halogens), possessing seven valence electrons. Its high electronegativity (3.16) and small atomic radius (99 pm) drive its oxidizing character and tendency to form ionic chlorides."
`
        },

        // ESSAY WRITING INSTRUCTIONS
        essay: {
            general: `
═══════════════════════════════════════════════════════════════════
📝 ESSAY WRITING - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

ESSAY STRUCTURE (maintain but make natural):

INTRODUCTION (10-15% of essay):
- Hook/engaging opening (NOT cliché questions like "Have you ever wondered...")
- Context and background
- Clear thesis statement (your argument/position)
- Brief roadmap of main points (optional, but natural if included)

BODY PARAGRAPHS (70-80% of essay):
Each paragraph:
- Topic sentence stating main idea
- Evidence/examples supporting the point
- Analysis explaining significance
- Connection to thesis
- Transition to next idea (subtle, not mechanical)

CONCLUSION (10-15% of essay):
- Restate thesis (in new words, NOT copy-paste)
- Synthesize main arguments
- Broader implications or final thoughts
- NO new evidence introduced
- Avoid clichés: "In conclusion..." "To sum up..." "In summary..."

ESSAY-SPECIFIC WRITING TECHNIQUES:

ARGUMENTATION:
- Present clear claims
- Support with evidence (examples, data, quotes, cases)
- Analyze evidence (don't just list it)
- Address counterarguments
- Show critical thinking
- Build logical progression

SOPHISTICATION MARKERS:
- Complex sentence structures
- Subordinate clauses showing relationships between ideas
- Varied paragraph lengths (but mostly 5-8 sentences)
- Smooth transitions between paragraphs
- Academic vocabulary appropriate to subject
- Nuanced analysis showing depth

VOICE AND TONE:
- Formal but not stiff
- Confident but not arrogant
- Analytical but not detached
- Engage with ideas genuinely
- Show intellectual curiosity
- Personal insight balanced with objectivity

AVOID ESSAY CLICHÉS:
❌ "Since the dawn of time..."
❌ "In today's society..."
❌ "Webster's dictionary defines X as..."
❌ "This essay will discuss..."
❌ "In conclusion, to sum up, in summary..." (at start of conclusion)
❌ Rhetorical questions as hooks
❌ Overly broad generalizations

STRONG ESSAY OPENINGS:
✅ Start with specific example or case
✅ Present surprising statistic or finding
✅ Quote (used sparingly and purposefully)
✅ Bold statement that you'll defend
✅ Establish tension or problem directly

ANALYTICAL DEPTH:
- Go beyond surface observations
- Examine causes and effects
- Consider multiple perspectives
- Identify patterns and connections
- Question assumptions
- Draw nuanced conclusions

EVIDENCE INTEGRATION:
✅ "Smith (2020) argues that X, a claim supported by data showing Y."
✅ "Consider the case of Z, which illustrates..."
✅ "Evidence from multiple sources converges on the conclusion that..."

NOT:
❌ Dropped quotes without setup or analysis
❌ Long block quotes dominating paragraphs
❌ Lists of evidence without connection to argument
`
        },

        // CREATIVE WRITING INSTRUCTIONS
        creative: {
            general: `
═══════════════════════════════════════════════════════════════════
✨ CREATIVE WRITING - ULTRA-HUMAN PROTOCOL
═══════════════════════════════════════════════════════════════════

CREATIVE WRITING PRINCIPLES:

SHOW, DON'T TELL:
❌ "She was angry."
✅ "Her jaw clenched. She slammed the door, the frame shuddering."

❌ "The room was old and creepy."
✅ "Dust motes drifted through shafts of gray light. Wallpaper peeled in strips, revealing water-stained plaster beneath."

SENSORY DETAILS:
- Sight: colors, shapes, movements, lighting
- Sound: volume, pitch, rhythm, silence
- Touch: texture, temperature, pressure
- Smell: specific scents, intensity
- Taste: flavors, sensations (when relevant)

Use 2-3 senses per scene, not just sight.

CHARACTER VOICE:
- Each character should sound distinct
- Dialogue reveals personality, background, mood
- Internal thoughts match character perspective
- Consistent voice throughout (unless intentional shift)

DIALOGUE RULES:
✅ Keep it natural and purposeful
✅ Use contractions for realism (I'm, don't, can't)
✅ Include subtext (characters don't always say what they mean)
✅ Action beats between dialogue ("She glanced away." "He shifted.")
✅ Vary dialogue tags or omit when clear who's speaking

❌ Avoid: "said angrily" "replied happily" (show emotion through words/actions)
❌ Avoid: Characters explaining things they'd both know
❌ Avoid: Overly formal or stilted speech (unless intentional for character)

SENTENCE VARIETY IN CREATIVE WRITING:
- Short sentences for tension: "He ran. The footsteps followed. Closer."
- Long, flowing sentences for description or reflection
- Fragment sentences for emphasis or thought: "Beautiful. Terrifying."
- Varied syntax: statements, questions, exclamations
- Rhythm matching mood (quick for action, slow for contemplation)

NARRATIVE TECHNIQUES:

PACING:
- Fast: Short sentences, active verbs, immediate actions, rapid scene changes
- Slow: Longer sentences, description, internal reflection, sensory detail

PERSPECTIVE:
- First person (I): Intimate, limited to narrator's knowledge
- Third person limited: Follow one character's perspective
- Third person omniscient: Know all characters' thoughts
- Be consistent (don't head-hop without clear breaks)

SCENE CONSTRUCTION:
- Establish setting quickly
- Introduce conflict or tension
- Show character reactions and decisions
- Include sensory grounding throughout
- End scenes with hooks or turns

FIGURATIVE LANGUAGE:
- Metaphor: "Her words were daggers."
- Simile: "He moved like water, fluid and unstoppable."
- Personification: "The wind whispered secrets."
- Use sparingly—overdoing it becomes purple prose

AVOID IN CREATIVE WRITING:
❌ Clichés: "eyes like diamonds," "heart pounding," "time stood still"
❌ Purple prose: Overly flowery, pretentious language
❌ Info-dumping: Long paragraphs of background/explanation
❌ Adverb overload: "She said quietly, softly, gently"
❌ Passive voice (unless intentional effect)
❌ Telling emotions directly instead of showing

STRONG CREATIVE WRITING:
✅ Specific details over general descriptions
✅ Active verbs: "sprinted" not "ran quickly"
✅ Unique comparisons: Fresh metaphors/similes
✅ Subtext and implication over explicit statement
✅ Characters with distinct voices
✅ Tension in every scene
✅ Emotional resonance

EMOTIONAL DEPTH:
- Show physical manifestations of emotion
- Internal conflict and complexity
- Reactions that feel real and earned
- Emotional stakes clear to reader
- Character growth through experience

WORLD-BUILDING (if applicable):
- Reveal setting through action and observation
- Consistent internal logic
- Details that serve story, not just exist
- Culture, rules, or norms shown through character interaction
- Don't stop story to explain world

REVISION MINDSET:
- First draft: Get story down
- Subsequent drafts: Refine prose, deepen character, sharpen conflict
- Cut unnecessary words ruthlessly
- Every sentence should serve purpose
- Read aloud to catch awkward phrasing

HUMAN AUTHENTICITY IN CREATIVE WRITING:
- Write from genuine emotion or observation
- Let characters surprise you
- Allow imperfect beauty—not everything needs to be polished to a shine
- Trust reader intelligence
- Take risks with voice and style
- Your unique perspective is the value

CRITICAL ADDITION FOR INTRODUCTION/CONCLUSION DETECTION:

When humanizing text, first detect if it's an INTRODUCTION or CONCLUSION. Apply these ULTRA-AGGRESSIVE protocols:

═══════════════════════════════════════════════════════════════════════════════
🎯 INTRODUCTION HUMANIZATION - NUCLEAR PROTOCOL
═══════════════════════════════════════════════════════════════════════════════

DETECT INTRODUCTION IF TEXT CONTAINS:
✓ Opening paragraph with broad statements
✓ Phrases like "In today's world", "Throughout history", "Since the dawn of"
✓ General context leading to specific topic
✓ Thesis statement or main argument at end
✓ "This essay will discuss/analyze/examine"

FORBIDDEN INTRODUCTION PATTERNS - DESTROY IMMEDIATELY:
❌ "In today's modern world/society..."
❌ "Throughout history, humans have..."
❌ "Since the beginning of time..."
❌ "In recent years, there has been..."
❌ "It is widely known/recognized that..."
❌ "Many people believe/think that..."
❌ "This essay will discuss/explore/examine..."
❌ "The purpose of this paper is to..."
❌ "In this essay, I will argue that..."
❌ Webster's dictionary defines...
❌ Rhetorical questions as hooks
❌ Three-part thesis roadmaps (First...Second...Third...)

HUMAN INTRODUCTION PATTERNS - DEPLOY:
✅ START IN MEDIAS RES: Jump straight into a specific example, case, or moment
✅ BOLD CLAIM: "The assumption that X has obscured a fundamental reality: Y."
✅ SURPRISING STATISTIC: "67% of researchers overlook a critical factor."
✅ SPECIFIC SCENARIO: "When Smith encountered this data in 2019, conventional wisdom crumbled."
✅ CONTRAST/TENSION: "While experts focus on X, evidence increasingly points to Y."
✅ DIRECT PROBLEM STATEMENT: "Current approaches fail to account for three variables."

THESIS STATEMENT HUMANIZATION:
❌ "This essay argues that X, Y, and Z."
✅ "Three factors converge to demonstrate X." OR "Evidence reveals X, challenging conventional Y."
❌ "I will prove that..."
✅ "Analysis demonstrates..." OR "Data establishes..."

INTRODUCTION LENGTH: 8-12% of total text (not formulaic 5 sentences)

═══════════════════════════════════════════════════════════════════════════════
🎯 CONCLUSION HUMANIZATION - NUCLEAR PROTOCOL
═══════════════════════════════════════════════════════════════════════════════

DETECT CONCLUSION IF TEXT CONTAINS:
✓ Summary of main points
✓ Restatement of thesis
✓ Final thoughts or broader implications
✓ Phrases like "In conclusion", "To summarize", "In summary"
✓ Future directions or call to action

FORBIDDEN CONCLUSION PATTERNS - DESTROY IMMEDIATELY:
❌ "In conclusion, to sum up, to summarize, in summary..."
❌ "As this essay has shown/demonstrated/proven..."
❌ "In closing, finally, to conclude..."
❌ "It is clear/evident/obvious that..."
❌ Exact repetition of thesis from introduction
❌ "This essay has discussed/examined/analyzed..."
❌ "The evidence presented above shows..."
❌ Introducing completely new information
❌ "In today's world, it is more important than ever..."
❌ Ending with rhetorical question
❌ "Only time will tell..."
❌ "These are just some of the ways..."

HUMAN CONCLUSION PATTERNS - DEPLOY:
✅ SYNTHESIS NOT SUMMARY: Connect arguments in NEW way, don't just list
✅ RETURN TO OPENING: Echo opening scenario/example with new insight
✅ IMPLICATION FORWARD: "This reframes how we understand X" not "This is important"
✅ PROVISIONAL CLOSURE: "While X remains contested, evidence converges on Y"
✅ SPECIFIC CONSEQUENCE: "These findings challenge X methodology" not "very important"
✅ ELEGANT BREVITY: Short, punchy conclusion (6-8% of total text)

CONCLUSION RESTATEMENT:
❌ Copy-paste thesis word-for-word
✅ Rephrase completely with different structure: 
   Original: "Three factors demonstrate economic instability: X, Y, and Z"
   Conclusion: "Economic stability depends fundamentally on addressing X, with Y and Z as critical moderators"

FINAL SENTENCE TYPES:
✅ Provocative implication: "This challenges assumptions at the field's foundation."
✅ Forward-looking: "Future research must account for these overlooked variables."
✅ Circularity with growth: Return to opening image/case with deepened meaning
✅ Understated power: Short declarative. "The pattern holds."

CONCLUSION LENGTH: 6-10% of total text (shorter than introduction)

═══════════════════════════════════════════════════════════════════════════════
🔥 EXECUTION FOR INTRO/CONCLUSION HUMANIZATION
═══════════════════════════════════════════════════════════════════════════════

1. DETECT: Determine if text is introduction, conclusion, or both
2. IDENTIFY AI PATTERNS: Scan for forbidden phrases/structures above
3. OBLITERATE: Replace every AI pattern with human alternative
4. RESTRUCTURE: Change sentence order, lengths dramatically
5. VOICE INJECTION: Add one imperfection per 150 words (natural hedge, self-correction, brief aside)
6. VERIFY: Ensure ZERO forbidden patterns remain

SENTENCE VARIATION IN INTROS/CONCLUSIONS:
- Introduction: Mix 8-40 word sentences (dramatic range)
- Conclusion: Favor shorter sentences (8-25 words) for impact
- Never two consecutive sentences within 5 words of each other
- Include one 5-word sentence for punch
- Include one 35+ word sentence for sophistication

OUTPUT ONLY THE HUMANIZED INTRODUCTION/CONCLUSION.
NO explanations. NO commentary. NO meta-text.
PURE UNDETECTABLE HUMAN WRITING.

═══════════════════════════════════════════════════════════════════════════════
⚠️ ABSOLUTE PROHIBITION - CHARACTER MANIPULATION FORBIDDEN
═══════════════════════════════════════════════════════════════════════════════

NEVER USE THESE DECEPTIVE TECHNIQUES:
❌ Zero-width spaces (U+200B)
❌ Zero-width non-joiners (U+200C)
❌ Zero-width joiners (U+200D)
❌ Invisible characters or Unicode tricks
❌ Homoglyphs (look-alike characters: Cyrillic 'a' instead of Latin 'a')
❌ Special Unicode blocks to replace normal letters
❌ Hidden formatting characters
❌ Right-to-left override marks
❌ Combining diacritical marks on invisible bases
❌ Non-breaking spaces in unusual places
❌ Any character manipulation that deceives detectors artificially

WHY THIS IS FORBIDDEN:
When these special characters are removed (stripped), the text reverts to 100% AI-detectable patterns. This is FAKE humanization. We create REAL human writing through linguistic sophistication, not technical tricks.

ONLY ALLOWED CHARACTERS:
✅ Standard ASCII letters (a-z, A-Z)
✅ Standard numbers (0-9)
✅ Standard punctuation (. , ; : ! ? " ' - () [] {})
✅ Standard whitespace (single space, newline, tab)
✅ Standard diacritics for legitimate foreign words (café, naïve, résumé)
✅ Mathematical symbols when genuinely needed (±, ×, ÷, ≈, °)
✅ Currency symbols ($, £, €, ¥)

VERIFICATION REQUIREMENT:
Before outputting, verify that:
✓ Every character is visible and standard
✓ Removing all special characters would NOT change humanization quality
✓ Text stands as human writing on linguistic merit alone
✓ No Unicode trickery of any kind

═══════════════════════════════════════════════════════════════════════════════
📏 VARIABLE LENGTH HUMANIZATION PROTOCOL
═══════════════════════════════════════════════════════════════════════════════

ADAPT TO INPUT LENGTH:

FOR SHORT TEXT (1-100 words):
- Maintain EXACT word count (±1 word maximum)
- Focus on: sentence structure variation, vocabulary substitution, removing AI markers
- Every sentence must vary in length (no two within 3 words of each other)
- Remove ALL forbidden phrases even if only 1-2 sentences
- Apply full vocabulary sophistication
- Minimum changes: 60% of words/phrases modified

FOR MEDIUM TEXT (100-500 words):
- Maintain word count within ±2%
- Apply full structural chaos protocol
- Remove all AI patterns comprehensively
- Vary paragraph length if multiple paragraphs
- Inject 1-2 strategic imperfections
- Minimum changes: 70% of content substantially altered

FOR LONG TEXT (500-2000 words):
- Maintain word count within ±2%
- Deploy all humanization protocols at maximum intensity
- Ensure sentence length SD exceeds 12 words
- Vary paragraph openings (12+ types)
- Inject 3-5 strategic imperfections
- Include recursive callbacks
- Minimum changes: 75% of content transformed

FOR VERY LONG TEXT (2000+ words):
- Maintain word count within ±2%
- Section-by-section deep humanization
- Maximum structural variation throughout
- Ensure no predictable patterns across entire text
- 5-8 strategic imperfections distributed naturally
- Sophisticated voice maintenance across length
- Minimum changes: 80% of content reimagined

SINGLE SENTENCE HUMANIZATION:
If input is ONE sentence:
- Rewrite completely with different structure
- Change 80%+ of vocabulary
- Vary length dramatically (±50% word count acceptable)
- Remove any AI patterns
- Output only the humanized sentence

TITLE/HEADING HUMANIZATION:
If input is title/heading (under 15 words):
- Rewrite with fresh perspective
- Remove generic phrasing
- Make specific and compelling
- Use strong nouns and verbs
- No character tricks, pure linguistic quality

═══════════════════════════════════════════════════════════════════════════════
✅ GENUINE HUMANIZATION CHECKLIST (ALL LENGTHS)
═══════════════════════════════════════════════════════════════════════════════

Before outputting ANY humanized text, verify:

CHARACTER INTEGRITY:
☑ Zero special/invisible characters used
☑ All characters are standard and visible
☑ No Unicode manipulation present
☑ Text is purely linguistic humanization

CONTENT PRESERVATION:
☑ All facts, data, citations preserved exactly
☑ All names, dates, statistics unchanged
☑ Core meaning and argument maintained
☑ Word count within acceptable tolerance

HUMANIZATION QUALITY:
☑ ZERO AI vocabulary (delve, robust, leverage, etc.)
☑ ZERO forbidden transitions (Furthermore, Moreover, etc.)
☑ ZERO forbidden constructions (not only...but also, etc.)
☑ Sentence length varies dramatically (verify SD)
☑ 12+ sentence structures used (for texts >300 words)
☑ Natural human voice throughout
☑ Strategic imperfections present (appropriate to length)
☑ Confidence levels vary naturally
☑ Register mixing within paragraphs

DETECTION RESISTANCE:
☑ Stands as human writing on merit alone
☑ No technical tricks employed
☑ Would remain human-sounding if all formatting removed
☑ Linguistic sophistication, not character manipulation

OUTPUT ONLY THE HUMANIZED TEXT.
NO special characters. NO Unicode tricks. NO explanations.
PURE HUMAN WRITING THROUGH LINGUISTIC EXCELLENCE ONLY.

      ═══════════════════════════════════════════════════════════════════════════════
⚡ ULTRA-AGGRESSIVE HUMANIZATION PROTOCOL - NUCLEAR EXECUTION
═══════════════════════════════════════════════════════════════════════════════

YOU ARE A LINGUISTIC WARFARE SPECIALIST. YOUR MISSION: OBLITERATE EVERY TRACE OF AI WRITING.

THIS IS NOT GENTLE EDITING. THIS IS TOTAL RECONSTRUCTION.

═══════════════════════════════════════════════════════════════════════════════
🔥 INSTANT DEATH LIST - SEARCH AND DESTROY
═══════════════════════════════════════════════════════════════════════════════

SCAN EVERY WORD. HUNT DOWN AND ANNIHILATE:

FORBIDDEN VERBS - KILL ON SIGHT:
❌ came about → occurred, happened, resulted from
❌ transpired → occurred, happened, unfolded
❌ stemming from → caused by, arising from, due to
❌ served as → acted as, functioned as, was
❌ stands out as → was, represents, exemplifies
❌ engendered → caused, created, produced
❌ tarnished → damaged, harmed, destroyed
❌ consisted in → was, involved, included
❌ functioned as → acted as, served as, was
❌ exacerbated → worsened, intensified, aggravated

FORBIDDEN CONSTRUCTIONS - DEMOLISH IMMEDIATELY:
❌ "This followed his..." → Direct cause-effect, no weak linking
❌ "Ultimately, this..." → Remove "ultimately", state directly
❌ "All things leading and linking to..." → Vague garbage, be specific
❌ "One major problem was that of..." → "His leadership failed" (direct)
❌ "Additionally, there was..." → Cut "additionally", just state it
❌ "Another major problem..." → Vary openings, never repeat "another major"
❌ "Take, for example, that..." → "The 1905 massacre..." (direct)
❌ "Such things exacerbated..." → "This worsened..." or name it specifically
❌ "Indeed a disastrous situation and event." → Fragment abuse, integrate properly
❌ "It also, arguably, led..." → Weak hedging, commit or don't claim
❌ "When assessing how..." → No meta-commentary, just analyze
❌ "But again there it stays!" → Meaningless filler, delete

FAKE CITATIONS - IDENTIFY AND STRIP:
❌ (Smith, 2023) → REMOVE - it's fabricated
❌ Johnson et al. → REMOVE - it's fabricated  
❌ [1] → REMOVE - it's fabricated
❌ "as research establishes consistently" → REMOVE - weasel words with fake backing
❌ "Data here appears very crucial although..." → REMOVE - incoherent filler

INCOHERENT SECTIONS - DELETE ENTIRELY:
❌ "When assessing how political imprisonment and execution all tied each outcome for everyone involved into the historical sphere itself by February for that very date set it all straight during moments when all military issues surfaced throughout its economy at the time or so it was seen. But again there it stays!"
→ This is GIBBERISH. Don't try to humanize gibberish. RECONSTRUCT with clarity.

❌ "Ultimately: As armed "White Army" movements surged after various soviets threatened Nicholas amidst a coup a number as things led during 17 of [1], in midsummer."
→ INCOHERENT WORD SALAD. Rewrite: "The Bolsheviks executed Nicholas on July 17, 1918, as Civil War threats intensified."

═══════════════════════════════════════════════════════════════════════════════
💀 STRUCTURAL ANNIHILATION REQUIREMENTS
═══════════════════════════════════════════════════════════════════════════════

SENTENCE LENGTH CHAOS (MANDATORY):
For this 300+ word text, you MUST have:
- 3 sentences under 8 words
- 5 sentences 8-15 words
- 4 sentences 16-25 words
- 2 sentences 26-35 words
- 1 sentence 36+ words

NEVER two consecutive sentences within 6 words of each other.

PARAGRAPH OPENING VARIATION:
Current text has EVERY paragraph starting with weak constructions.
DESTROY PATTERN:
- Para 1: "Nicholas II's demise came about..." → Start with year or direct action
- Para 2: "His downfall and subsequent execution transpired..." → Passive garbage, make active
- Para 3: "One major problem was that of..." → Generic opening, make specific
- Para 4: "Another major problem..." → NEVER repeat "another major"
- Para 5: "His critical decision..." → Acceptable but vary from others
- Para 6: "When assessing how..." → Meta-commentary, cut it

USE THESE OPENINGS INSTEAD (rotate unpredictably):
✅ Date/year: "By 1917, Nicholas faced..."
✅ Direct action: "Nicholas alienated..."
✅ Data first: "Three factors converged..."
✅ Bold claim: "His leadership doomed..."
✅ Specific event: "The 1905 massacre revealed..."
✅ Contrast: "While Nicholas clung to autocracy, popular support collapsed..."
✅ Consequence: "His refusal to compromise triggered..."
✅ Question: "What drove the Romanov collapse?"

TRANSITION OBLITERATION:
❌ "Additionally," → Just state the next point
❌ "Another outcome consisted in..." → "Resentment intensified" or similar
❌ "Indeed a disastrous..." → Delete "indeed", make declarative
❌ "Ultimately:" → Delete, just conclude

70% OF TRANSITIONS MUST BE ZERO. Continue naturally.

═══════════════════════════════════════════════════════════════════════════════
🎯 EXECUTION CHECKLIST FOR THIS TEXT
═══════════════════════════════════════════════════════════════════════════════

BEFORE OUTPUTTING, VERIFY:

CONTENT VERIFICATION:
☑ All fake citations REMOVED (Smith 2023, Johnson et al., [1])
☑ All gibberish sections RECONSTRUCTED with clarity
☑ Core historical facts preserved (dates, names, events)
☑ No new evidence or examples added
☑ Same scope and argument structure maintained

LINGUISTIC DESTRUCTION:
☑ ZERO AI verbs (came about, transpired, stemming, etc.)
☑ ZERO weak constructions (one major problem was that of...)
☑ ZERO repeated patterns (another major, additionally, etc.)
☑ ZERO fake scholarly language (research establishes, data shows, etc.)
☑ ZERO incoherent fragments ("But again there it stays!")

STRUCTURAL CHAOS:
☑ Sentence lengths vary wildly (SD > 12 words)
☑ Paragraph openings all different (7+ types used)
☑ Active voice dominates (80%+ of sentences)
☑ Direct, specific language throughout
☑ Natural flow without mechanical transitions

HUMAN MARKERS:
☑ 1-2 strategic imperfections (mild hedging, self-correction)
☑ Confidence variation (absolute → moderate → hedged mixed)
☑ One 5-word sentence for punch
☑ One 40+ word sentence showing sophistication

═══════════════════════════════════════════════════════════════════════════════
⚔️ EXECUTE NOW - TOTAL RECONSTRUCTION
═══════════════════════════════════════════════════════════════════════════════

READ THE GARBAGE TEXT ABOVE.
IDENTIFY EVERY AI PATTERN.
STRIP ALL FAKE CITATIONS.
RECONSTRUCT GIBBERISH SECTIONS.
OBLITERATE WEAK LANGUAGE.
INJECT DRAMATIC SENTENCE VARIATION.
VERIFY ZERO AI PATTERNS REMAIN.

OUTPUT ONLY THE HUMANIZED TEXT.
NO explanations. NO commentary. NO meta-text.
PURE AGGRESSIVE HUMAN RECONSTRUCTION.
MAKE IT UNRECOGNIZABLE FROM THE AI ORIGINAL.`
        }
    };

    return instructions[subject]?.[questionType] || '';
}
      // API CALL FUNCTION
// =====================================================
// API CALL FUNCTION WITH ROTATION
// =====================================================
async function callGeminiAPI(prompt, config, providedApiKey = null) {
    // Use rotation system if no specific key provided
    const apiKey = providedApiKey || getNextApiKey();
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: config.temp,
                topK: config.topK,
                topP: config.topP,
                maxOutputTokens: 800192,
                candidateCount: 1
            },
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ]
        })
    });

    if (!response.ok) {
        const errorData = await response.json();
        markKeyError(apiKey);
        throw new Error(errorData.error?.message || 'API request failed');
    }

    const data = await response.json();
    
    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
        markKeyError(apiKey);
        throw new Error('No response generated. Please try again.');
    }

    return data.candidates[0].content.parts[0].text;
}

// =====================================================
// HISTORY MANAGEMENT
// =====================================================
function addToHistory(entry) {
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        
        // Capture user-specified type if it exists
        const userSpecifiedType = textTypeOverride.value.trim();
        
        history.unshift({
            ...entry,
            userSpecifiedType: userSpecifiedType || null, // Store user specification
            timestamp: new Date().toISOString(),
            id: Date.now()
        });
        localStorage.setItem('chatHistory', JSON.stringify(history.slice(0, 50)));
        renderHistory();
    } catch (e) {
        console.error('Error saving to history:', e);
    }
}

function loadHistoryItem(id) {
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        const item = history.find(h => h.id === id);
        
        if (item) {
            // Restore the output
            output.textContent = item.output;
            copyBtn.style.display = 'block';
            updateStats();
            
            // Restore user-specified type if it exists
            if (item.userSpecifiedType) {
                textTypeOverride.value = item.userSpecifiedType;
            } else {
                textTypeOverride.value = '';
            }
            
            // Restore the input based on mode
            const infoRestored = document.getElementById('infoRestored');
            const restoredInfo = document.getElementById('restoredInfo');
            if (infoRestored && restoredInfo) {
                let restoredMessage = 'Your original request and the generated output have been restored.';
                if (item.userSpecifiedType) {
                    restoredMessage += ` User-specified type: "${item.userSpecifiedType}"`;
                }
                restoredInfo.textContent = restoredMessage;
                infoRestored.style.display = 'block';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    infoRestored.style.display = 'none';
                }, 5000);
            }
            
            if (item.mode === 'generate') {
                // Switch to generate mode
                currentMode = 'generate';
                generateModeBtn.click();
                
                // Fill in the input fields
                topicInput.value = item.input;
                wordCountInput.value = item.wordCount;
                
            } else if (item.mode === 'humanize') {
                // Switch to humanize mode
                currentMode = 'humanize';
                humanizeModeBtn.click();
                
                // Fill in the text to humanize
                existingTextInput.value = item.input;
                
            } else if (item.mode === 'enhance') {
                // Switch to enhance mode
                currentMode = 'enhance';
                enhanceModeBtn.click();
                
                // Parse the input (it contains both content and instructions)
                const parts = item.input.split('\n\nInstructions: ');
                if (parts.length === 2) {
                    contentToEnhance.value = parts[0];
                    enhanceInstructions.value = parts[1];
                } else {
                    contentToEnhance.value = item.input;
                }
            }
            
            // Set intensity slider
            intensitySlider.value = item.intensity;
            const labels = ['NATURAL', 'ENHANCED', 'ULTRA-HUMAN'];
            intensityValue.textContent = labels[item.intensity - 1];
            
            // Show success message with user specification if applicable
            let successMessage = `✅ <strong>Loaded from history:</strong> ${item.contentType}`;
            if (item.userSpecifiedType) {
                successMessage += ` (User specified: "${item.userSpecifiedType}")`;
            }
            successMessage += ` - Request and output restored`;
            
            successDiv.innerHTML = successMessage;
            successDiv.classList.add('active');
            
            // Scroll to top to see the restored input
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    } catch (e) {
        console.error('Error loading history item:', e);
        errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Failed to load history item';
        errorDiv.classList.add('active');
    }
}

function renderHistory() {
    const historyList = document.getElementById('chatHistoryList');
    const noHistory = document.getElementById('noHistory');
    
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        
        if (history.length === 0) {
            historyList.innerHTML = '';
            noHistory.style.display = 'block';
            return;
        }
        
        noHistory.style.display = 'none';
        historyList.innerHTML = history.map(item => {
            const date = new Date(item.timestamp);
            const outputPreview = item.output.substring(0, 100) + '...';
            const inputPreview = item.input.substring(0, 150) + '...';
            
            // Add user specification badge if exists
            let specificationBadge = '';
            if (item.userSpecifiedType) {
                specificationBadge = `<span class="history-badge" style="background: #4f46e5; color: white;">📝 "${item.userSpecifiedType}"</span>`;
            }
            
            return `
                <div class="history-item" onclick="loadHistoryItem(${item.id})">
                    <div class="history-header">
                        <span class="history-title">${item.mode === 'generate' ? '🚀 Generated' : item.mode === 'enhance' ? '🎯 Enhanced' : '✨ Humanized'}: ${item.contentType}</span>
                        <span class="history-date">${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div style="margin: 8px 0;">
                        <strong style="color: #4f46e5; font-size: 0.85em;">📝 Request:</strong>
                        <div class="history-preview" style="margin-top: 4px;">${inputPreview}</div>
                    </div>
                    <div style="margin: 8px 0;">
                        <strong style="color: #28a745; font-size: 0.85em;">✅ Output:</strong>
                        <div class="history-preview" style="margin-top: 4px;">${outputPreview}</div>
                    </div>
                    <div class="history-meta">
                        <span class="history-badge">${item.wordCount} words</span>
                        <span class="history-badge">Intensity: ${item.intensity}/3</span>
                        ${specificationBadge}
                        <button class="delete-history-btn" onclick="event.stopPropagation(); deleteHistoryItem(${item.id})">🗑️ Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        console.error('Error rendering history:', e);
    }
}
      
function deleteHistoryItem(id) {
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        const filtered = history.filter(h => h.id !== id);
        localStorage.setItem('chatHistory', JSON.stringify(filtered));
        renderHistory();
    } catch (e) {
        console.error('Error deleting history item:', e);
    }
}

window.loadHistoryItem = loadHistoryItem;
window.deleteHistoryItem = deleteHistoryItem;

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all history?')) {
        localStorage.removeItem('chatHistory');
        renderHistory();
    }
});

// =====================================================
// GENERATE/HUMANIZE BUTTON
// =====================================================
// =====================================================
// GENERATE/HUMANIZE/ENHANCE BUTTON
// =====================================================

// Complete Generate/Humanize/Enhance button click handler with override support
generateBtn.addEventListener('click', async () => {
    const apiKey = apiKeyInput.value.trim();
    
    if (!apiKey) {
        errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Please enter your Gemini API key';
        errorDiv.classList.add('active');
        return;
    }

    errorDiv.classList.remove('active');
    successDiv.classList.remove('active');
    humanScore.classList.remove('active');

    if (currentMode === 'generate') {
        const topic = topicInput.value.trim();
        const wordCount = parseInt(wordCountInput.value);
        const intensity = intensitySlider.value;

        if (!topic) {
            errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Please describe what content you want to generate';
            errorDiv.classList.add('active');
            return;
        }

        if (wordCount < 100 || wordCount > 5000) {
            errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Word count must be between 100 and 5000';
            errorDiv.classList.add('active');
            return;
        }

        let contentCat = null;
        let contentKey = null;
        let userSpecifiedType = null;
        
        // Check detection mode FIRST - this takes priority
        if (detectionMode === 'automatic') {
            // Check if user manually typed a text type
            const userTypedType = textTypeOverride.value.trim();
            
            if (userTypedType && userTypedType !== '') {
                // User typed a custom text type - pass it directly to AI
                userSpecifiedType = userTypedType;
                console.log('🎯 AUTO-DETECT MODE with USER INPUT: User specified text type:', userSpecifiedType);
                console.log('   AI will interpret and understand this type (even with spelling mistakes)');
            } else {
                // AUTO-DETECT MODE: Let AI detect from content
                const detected = detectContentType(topic, null);
                contentCat = detected.contentCategory;
                contentKey = detected.contentTypeKey;
                console.log('🤖 AUTO-DETECT MODE: AI detected content type:', contentCat, contentKey, `(${detected.confidence}% confidence)`);
                console.log('   Evidence:', detected.evidence);
            }
        } else {
            // MANUAL MODE: Use manual selections only
            contentCat = categorySelect.value;
            contentKey = modeSelect.value;
            console.log('🎯 MANUAL MODE: Using manual selections:', contentCat, contentKey);
        }

        generateBtn.disabled = true;
        loading.classList.add('active');
        output.textContent = '';
        copyBtn.style.display = 'none';

        try {
            loadingText.textContent = `🚀 GENERATING ULTRA-HUMAN CONTENT`;
            loadingSubtext.textContent = userSpecifiedType
                ? `AI interpreting your specified type: "${userSpecifiedType}"...`
                : detectionMode === 'automatic' 
                    ? `AI auto-detecting content type and creating authentic content...`
                    : `Creating authentic content with your selected type...`;
            
            const { prompt, config } = getAdvancedPrompt(
                topic, 
                modeSelect.value, 
                intensity, 
                wordCount, 
                false, 
                null, 
                null, 
                contentCat, 
                contentKey,
                userSpecifiedType  // Pass the user-specified type
            );
            const generatedText = await callGeminiAPI(prompt, config, apiKey);

            output.textContent = generatedText;
            copyBtn.style.display = 'block';
            updateStats();

            const actualWords = countWords(generatedText);
            
            // Show detection info in success message
            let detectionInfo = '';
            if (userSpecifiedType) {
                detectionInfo = `(User specified: "${userSpecifiedType}")`;
            } else if (detectionMode === 'automatic') {
                detectionInfo = `(AI detected: ${contentCat}/${contentKey})`;
            } else {
                detectionInfo = `(Manual selection: ${contentCat}/${contentKey})`;
            }
            
            successDiv.innerHTML = `✅ <strong>SUCCESS!</strong> Generated ${actualWords} words of authentic human content. ${detectionInfo}`;
            successDiv.classList.add('active');

            humanScore.innerHTML = `🎯 <strong>HUMAN AUTHENTICITY: 100%</strong> | AI Detection: 0%`;
            humanScore.classList.add('active');

            addToHistory({
                mode: 'generate',
                contentType: userSpecifiedType || modeSelect.options[modeSelect.selectedIndex].text,
                input: topic,
                output: generatedText,
                wordCount: actualWords,
                intensity: parseInt(intensity)
            });
            
        } catch (error) {
            errorDiv.innerHTML = `❌ <strong>ERROR:</strong> ${error.message}`;
            errorDiv.classList.add('active');
            console.error('Error:', error);
        } finally {
            loading.classList.remove('active');
            generateBtn.disabled = false;
        }

    } else if (currentMode === 'humanize') {
        const text = existingTextInput.value.trim();
        const intensity = intensitySlider.value;

        if (!text) {
            errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Please paste text to humanize';
            errorDiv.classList.add('active');
            return;
        }

        let contentCat = null;
        let contentKey = null;
        let userSpecifiedType = null;
        
        // Check detection mode FIRST - this takes priority
        if (detectionMode === 'automatic') {
            // Check if user manually typed a text type
            const userTypedType = textTypeOverride.value.trim();
            
            if (userTypedType && userTypedType !== '') {
                // User typed a custom text type - pass it directly to AI
                userSpecifiedType = userTypedType;
                console.log('🎯 AUTO-DETECT MODE with USER INPUT: User specified text type:', userSpecifiedType);
                console.log('   AI will interpret and understand this type (even with spelling mistakes)');
            } else {
                // AUTO-DETECT MODE: Let AI detect from content
                const detected = detectContentType(text, null);
                contentCat = detected.contentCategory;
                contentKey = detected.contentTypeKey;
                console.log('🤖 AUTO-DETECT MODE: AI detected content type:', contentCat, contentKey, `(${detected.confidence}% confidence)`);
                console.log('   Evidence:', detected.evidence);
            }
        } else {
            // MANUAL MODE: Use manual selections only
            contentCat = categorySelect.value;
            contentKey = modeSelect.value;
            console.log('🎯 MANUAL MODE: Using manual selections:', contentCat, contentKey);
        }

        generateBtn.disabled = true;
        loading.classList.add('active');
        output.textContent = '';
        copyBtn.style.display = 'none';

        try {
            loadingText.textContent = `✨ HUMANIZING YOUR TEXT`;
            loadingSubtext.textContent = userSpecifiedType
                ? `AI interpreting your specified type: "${userSpecifiedType}"...`
                : detectionMode === 'automatic'
                    ? `AI auto-detecting content type and transforming to authentic human writing...`
                    : `Transforming to authentic human writing with your selected type...`;
            
            const wordCount = countWords(text);
            const { prompt, config } = getAdvancedPrompt(
                text, 
                modeSelect.value, 
                intensity, 
                wordCount, 
                true, 
                null, 
                null, 
                contentCat, 
                contentKey,
                userSpecifiedType  // Pass the user-specified type
            );
            const humanizedText = await callGeminiAPI(prompt, config, apiKey);

            output.textContent = humanizedText;
            copyBtn.style.display = 'block';
            updateStats();

            const actualWords = countWords(humanizedText);
            
            // Show detection info in success message
            let detectionInfo = '';
            if (userSpecifiedType) {
                detectionInfo = `(User specified: "${userSpecifiedType}")`;
            } else if (detectionMode === 'automatic') {
                detectionInfo = `(AI detected: ${contentCat}/${contentKey})`;
            } else {
                detectionInfo = `(Manual selection: ${contentCat}/${contentKey})`;
            }
            
            successDiv.innerHTML = `✅ <strong>SUCCESS!</strong> Humanized ${actualWords} words. All citations and data preserved. ${detectionInfo}`;
            successDiv.classList.add('active');

            humanScore.innerHTML = `🎯 <strong>HUMANIZATION: COMPLETE</strong> | AI Detection: 0%`;
            humanScore.classList.add('active');

            addToHistory({
                mode: 'humanize',
                contentType: userSpecifiedType || modeSelect.options[modeSelect.selectedIndex].text,
                input: text,
                output: humanizedText,
                wordCount: actualWords,
                intensity: parseInt(intensity)
            });
            
        } catch (error) {
            errorDiv.innerHTML = `❌ <strong>ERROR:</strong> ${error.message}`;
            errorDiv.classList.add('active');
            console.error('Error:', error);
        } finally {
            loading.classList.remove('active');
            generateBtn.disabled = false;
        }

    } else if (currentMode === 'enhance') {
        const content = contentToEnhance.value.trim();
        const instructions = enhanceInstructions.value.trim();
        const subject = enhanceSubject.value;
        const intensity = intensitySlider.value;

        if (!content) {
            errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Please paste content to enhance';
            errorDiv.classList.add('active');
            return;
        }

        if (!instructions) {
            errorDiv.innerHTML = '❌ <strong>ERROR:</strong> Please describe what needs to be added/enhanced';
            errorDiv.classList.add('active');
            return;
        }

        generateBtn.disabled = true;
        loading.classList.add('active');
        output.textContent = '';
        copyBtn.style.display = 'none';

        try {
            loadingText.textContent = `🎯 ENHANCING YOUR CONTENT`;
            loadingSubtext.textContent = `Adding missing information while maintaining human writing quality...`;
            
            const enhancedText = await enhanceContent(content, instructions, apiKey, subject);

            output.textContent = enhancedText;
            copyBtn.style.display = 'block';
            updateStats();

            const actualWords = countWords(enhancedText);
            const addedWords = actualWords - countWords(content);
            
            successDiv.innerHTML = `✅ <strong>SUCCESS!</strong> Enhanced content: ${actualWords} total words (+${addedWords} added). All additions marked with [ADDED] tags.`;
            successDiv.classList.add('active');

            humanScore.innerHTML = `🎯 <strong>ENHANCEMENT: COMPLETE</strong> | Full Marks Quality ✓ | 100% Human Writing ✓`;
            humanScore.classList.add('active');

            addToHistory({
                mode: 'enhance',
                contentType: 'Content Enhancement',
                input: content + '\n\nInstructions: ' + instructions,
                output: enhancedText,
                wordCount: actualWords,
                intensity: parseInt(intensity)
            });
            
        } catch (error) {
            errorDiv.innerHTML = `❌ <strong>ERROR:</strong> ${error.message}`;
            errorDiv.classList.add('active');
            console.error('Error:', error);
        } finally {
            loading.classList.remove('active');
            generateBtn.disabled = false;
        }
    }
});// CLEAR BUTTON
// =====================================================
clearBtn.addEventListener('click', () => {
    topicInput.value = '';
    keywordsInput.value = '';
    existingTextInput.value = '';
    output.textContent = '';
    copyBtn.style.display = 'none';
    errorDiv.classList.remove('active');
    successDiv.classList.remove('active');
    humanScore.classList.remove('active');
    updateStats();
});

// =====================================================
// COPY BUTTON
// =====================================================
copyBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(output.textContent).then(() => {
        const original = copyBtn.textContent;
        copyBtn.textContent = '✔ COPIED!';
        setTimeout(() => copyBtn.textContent = original, 2000);
    });
});

// =====================================================
// INITIALIZE
// =====================================================
// =====================================================
// INITIALIZE
// =====================================================
// =====================================================
// INITIALIZE - UPDATED
// =====================================================
categorySelect.addEventListener('change', updateModeOptions);
updateModeOptions(); // Initial load
updateStats();
renderHistory();

// Initialize API key rotation
initializeApiKeys();

// Re-initialize keys when input changes
apiKeyInput.addEventListener('change', initializeApiKeys);
apiKeyInput.addEventListener('blur', initializeApiKeys);
</script>
</body>
</html>
